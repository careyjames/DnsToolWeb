<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#212529">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{{ domain }} - DNS Tool</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link href="{{ url_for('static', filename='css/bootstrap-dark-theme.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.min.css') }}?v={{ app_version }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome-subset.min.css') }}">
    <style nonce="{{ csp_nonce }}">
        :root{--bs-body-bg:#212529;--bs-body-color:#dee2e6;--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-body-font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display',system-ui,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;--bs-font-sans-serif:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display',system-ui,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
        *,::after,::before{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background-color:var(--bs-body-bg);color:var(--bs-body-color);line-height:1.5;-webkit-font-smoothing:antialiased}
        .navbar{display:flex;padding:.5rem 1rem;background-color:#212529!important}
        .navbar-brand{color:#fff;text-decoration:none;font-size:1.25rem;padding:.3125rem 0}
        .container{width:100%;max-width:1140px;margin:0 auto;padding:0 .75rem}
        .card{background-color:#2b3035;border:1px solid #495057;border-radius:.375rem}
        .card-body{padding:1rem}
        .badge{display:inline-block;padding:.35em .65em;font-size:.75em;font-weight:700;border-radius:.25rem}
        .fas,.fab,.far,.fa{display:inline-block;width:1em;height:1em;min-width:1em;vertical-align:-0.125em}
        .d-none{display:none}
        .collapse:not(.show){display:none}
        @media(min-width:992px){.collapse.navbar-collapse{display:flex!important}}
        .visually-hidden-focusable{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.visually-hidden-focusable:focus{position:fixed;top:0;left:0;width:auto;height:auto;padding:1rem;margin:0;overflow:visible;clip:auto;background:#0d6efd;color:#fff;z-index:9999;font-size:1rem}
        @media print {
            /* Hide non-printable elements */
            .navbar, .btn, button, .no-print { display: none !important; }
            
            /* Preserve colors in print */
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            
            /* Avoid page breaks inside cards */
            .card { break-inside: avoid; }
            
            /* Fix hosting summary - prevent text truncation */
            .text-truncate { 
                overflow: visible !important; 
                text-overflow: clip !important; 
                white-space: normal !important;
            }
            
            /* Make hosting summary columns wider in print */
            .col-md-3 { 
                flex: 0 0 50% !important; 
                max-width: 50% !important;
                margin-bottom: 0.5rem !important;
            }
            
            /* Ensure footer prints */
            footer { 
                display: block !important; 
                visibility: visible !important;
                margin-top: 2rem !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="visually-hidden-focusable">Skip to main content</a>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" aria-label="Main navigation">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-globe me-2"></i>DNS Tool <span class="badge bg-info text-dark ms-1">v{{ app_version }}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('history') }}">
                            <i class="fas fa-history me-1"></i>History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('stats') }}">
                            <i class="fas fa-chart-bar me-1"></i>Statistics
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main id="main-content" class="container my-4">
        <!-- Header -->
        <div class="results-header mb-4">
            <div class="results-header-info">
                <h1 class="h3 mb-1">DNS Intelligence Report</h1>
                <div class="text-muted">
                    <strong>{{ domain }}</strong>
                    {% if ascii_domain != domain %}
                        <span class="badge bg-secondary ms-2">ASCII: {{ ascii_domain }}</span>
                    {% endif %}
                </div>
                {% if analysis_timestamp or analysis_duration %}
                <div class="small text-muted results-meta" style="opacity: 0.7;">
                    {% if analysis_timestamp %}<i class="fas fa-clock me-1"></i><span>{{ analysis_timestamp.strftime('%Y-%m-%d %H:%M UTC') }}</span>{% endif %}
                    {% if analysis_timestamp and analysis_duration %}<span class="mx-1">·</span>{% endif %}
                    {% if analysis_duration %}<i class="fas fa-stopwatch me-1"></i><span>{{ "%.1f"|format(analysis_duration) }}s</span>{% endif %}
                    {% if results and results.get('_tool_version') %}
                        <span class="mx-1">·</span><i class="fas fa-tag me-1"></i><span>v{{ results['_tool_version'] }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="results-header-actions">
                <button type="button" id="reanalyzeBtn" class="btn btn-primary" data-domain="{{ domain }}"
                    {% if wait_seconds %}data-wait-seconds="{{ wait_seconds }}" data-wait-reason="{{ wait_reason }}"{% endif %}>
                    <i class="fas fa-sync-alt me-2"></i>Re-analyze
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-search me-2"></i>New Domain
                </a>
            </div>
        </div>
        
        <!-- Non-existent Domain Banner -->
        {% if results.domain_exists == false %}
        <div class="card border-info mb-4">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-question-circle fa-4x text-info opacity-75"></i>
                </div>
                <h2 class="h3 mb-3">
                    <span class="badge bg-info-subtle text-info border border-info px-4 py-2">
                        <i class="fas fa-globe-americas me-2"></i>Non-existent / Undelegated Domain
                    </span>
                </h2>
                <p class="lead text-muted mb-4">{{ results.domain_status_message or 'This domain does not exist in DNS.' }}</p>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="alert alert-info border-info mb-0 text-light" style="background-color: rgba(13, 202, 240, 0.15);">
                            <h6 class="alert-heading mb-2 text-info"><i class="fas fa-info-circle me-2"></i>What This Means</h6>
                            <ul class="text-start mb-0 small">
                                <li>No authoritative DNS data is available for this domain</li>
                                <li>Security posture cannot be evaluated without DNS records</li>
                                <li>The domain may never have been registered, or has expired</li>
                                <li>If this is your domain, check your registrar to ensure it's active</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-search me-2"></i>Try Another Domain
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        
        
        <!-- Global Posture Score -->
        {% if results.posture %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-{{ results.posture.color }} bg-{{ results.posture.color }} bg-opacity-10">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-{{ results.posture.icon }} fa-2x text-{{ results.posture.color }} me-3"></i>
                                <div>
                                    <div class="d-flex align-items-center">
                                        <span class="text-muted small me-2">DNS & Trust Posture:</span>
                                        <span class="badge bg-{{ results.posture.color }} fs-6 px-3 py-2">{{ results.posture.state }}</span>
                                    </div>
                                    <small class="text-muted">{{ results.posture.message }}</small>
                                    {% if results.posture.deliberate_monitoring %}
                                    <small class="text-info d-block mt-1"><i class="fas fa-flask me-1"></i>{{ results.posture.deliberate_monitoring_note }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% if results.posture.issues or results.posture.monitoring %}
                            <div class="mt-2 mt-md-0">
                                {% if results.posture.issues %}
                                    <small class="text-danger d-block"><i class="fas fa-times-circle me-1"></i>{{ results.posture.issues|length }} issue{{ 's' if results.posture.issues|length > 1 else '' }}</small>
                                {% endif %}
                                {% if results.posture.monitoring %}
                                    <small class="text-info d-block"><i class="fas fa-eye me-1"></i>{{ results.posture.monitoring|length }} monitoring</small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Partial Failure Banner - Shows if any sections timed out or failed -->
        {% set failed_sections = [] %}
        {% if results.section_status %}
            {% for key, info in results.section_status.items() %}
                {% if info.status in ['timeout', 'error'] %}
                    {% set _ = failed_sections.append({'key': key, 'status': info.status, 'message': info.message}) %}
                {% endif %}
            {% endfor %}
        {% endif %}
        {% if failed_sections %}
        <div class="alert alert-warning alert-dismissible fade show py-2 mb-3" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Partial Results:</strong> 
            Some lookups experienced issues: 
            {% for s in failed_sections %}
                <span class="badge bg-{{ 'secondary' if s.status == 'timeout' else 'danger' }} me-1">
                    {{ s.key|replace('_', ' ')|title }} ({{ s.status }})
                </span>
            {% endfor %}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close alert"></button>
        </div>
        {% endif %}
        
        <!-- Executive Scorecard - At-a-Glance Security Status -->
        {% if results.posture %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-dark bg-opacity-25" style="border: 1px solid rgba(255,255,255,0.1);">
                    <div class="card-body py-3 px-3">
                        <div class="row g-3 text-center">
                            <div class="col-6 col-md-3">
                                <div class="small text-muted text-uppercase mb-1">Email Spoofing</div>
                                {% set spf_ok = results.spf_analysis.status == 'success' %}
                                {% set dmarc_ok = results.dmarc_analysis.status == 'success' %}
                                {% set dmarc_enforced = results.dmarc_analysis.policy in ['reject', 'quarantine'] %}
                                {% if spf_ok and dmarc_ok and dmarc_enforced %}
                                <span class="badge bg-success px-3 py-2">Protected</span>
                                {% elif spf_ok and dmarc_ok and results.dmarc_analysis.policy == 'none' %}
                                <span class="badge bg-info px-3 py-2">Monitoring</span>
                                {% elif spf_ok or dmarc_ok %}
                                <span class="badge bg-warning text-dark px-3 py-2">Partial</span>
                                {% else %}
                                <span class="badge bg-danger px-3 py-2">Vulnerable</span>
                                {% endif %}
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="small text-muted text-uppercase mb-1">Brand Impersonation</div>
                                {% if results.bimi_analysis and results.bimi_analysis.status == 'success' and results.bimi_analysis.vmc_valid %}
                                <span class="badge bg-success px-3 py-2">Protected</span>
                                {% elif results.bimi_analysis and results.bimi_analysis.status == 'success' %}
                                <span class="badge bg-info px-3 py-2">Basic</span>
                                {% else %}
                                <span class="badge bg-secondary px-3 py-2">Not Setup</span>
                                {% endif %}
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="small text-muted text-uppercase mb-1">DNS Tampering</div>
                                {% if results.dnssec_analysis.status == 'success' %}
                                <span class="badge bg-success px-3 py-2">Protected</span>
                                {% elif results.dns_infrastructure and results.dns_infrastructure.provider_tier == 'enterprise' %}
                                <span class="badge bg-info px-3 py-2">Enterprise</span>
                                {% else %}
                                <span class="badge bg-warning text-dark px-3 py-2">Unsigned</span>
                                {% endif %}
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="small text-muted text-uppercase mb-1">Certificate Control</div>
                                {% if results.caa_analysis and results.caa_analysis.status == 'success' %}
                                <span class="badge bg-success px-3 py-2">Configured</span>
                                {% else %}
                                <span class="badge bg-secondary px-3 py-2">Open</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Findings Summary Block - Clean 2-Column Layout -->
        {% if results.posture and (results.posture.issues or results.posture.monitoring or results.posture.configured or results.posture.absent) %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card border-0 bg-dark bg-opacity-50">
                    <div class="card-body py-2 px-3">
                        <div class="row g-2 align-items-start small">
                            {% if results.posture.issues %}
                            <div class="col-6 col-lg-3">
                                <span class="text-danger fw-bold"><i class="fas fa-times-circle me-1"></i>Action Required</span>
                                <div class="text-danger-emphasis">{% for issue in results.posture.issues %}{{ issue }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                            {% if results.posture.monitoring %}
                            <div class="col-6 col-lg-3">
                                <span class="text-warning fw-bold"><i class="fas fa-eye me-1"></i>Monitoring</span>
                                <div class="text-warning-emphasis">{% for item in results.posture.monitoring %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                            {% if results.posture.configured %}
                            <div class="col-6 col-lg-3">
                                <span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Configured</span>
                                <div class="text-success-emphasis">{% for item in results.posture.configured %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                            {% if results.posture.absent %}
                            <div class="col-6 col-lg-3">
                                <span class="text-muted fw-bold"><i class="fas fa-minus-circle me-1"></i>Not Configured</span>
                                <div class="text-muted">{% for item in results.posture.absent %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- Top Fixes Panel - Actionable Remediation Guidance -->
        {% if results.remediation and results.remediation.top_fixes %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card border-0 bg-dark bg-opacity-50" style="border-left: 3px solid var(--bs-warning) !important;">
                    <div class="card-body py-3 px-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-wrench text-warning me-2"></i>
                            <strong class="small text-warning">Top {{ results.remediation.top_fixes|length }} Fix{{ 'es' if results.remediation.top_fixes|length > 1 else '' }}</strong>
                            {% if results.remediation.fix_count > 3 %}
                            <span class="badge bg-secondary bg-opacity-50 ms-2 small">{{ results.remediation.fix_count }} total</span>
                            {% endif %}
                            {% if results.remediation.posture_achievable %}
                            <span class="ms-auto small text-muted">Achievable posture: <span class="badge bg-{{ 'success' if results.remediation.posture_achievable in ('SECURE', 'STRONG') else 'warning' }}">{{ results.remediation.posture_achievable }}</span></span>
                            {% endif %}
                        </div>
                        <div class="row g-2">
                            {% for fix in results.remediation.top_fixes %}
                            <div class="col-md-4">
                                <div class="p-2 rounded bg-dark bg-opacity-75 h-100">
                                    <div class="d-flex align-items-start mb-1">
                                        <span class="badge bg-{{ fix.severity_color }} me-2" style="min-width: 52px; font-size: 0.65rem;">{{ fix.severity_label }}</span>
                                        <strong class="small">{{ fix.title }}</strong>
                                    </div>
                                    <p class="text-muted mb-1" style="font-size: 0.75rem;">{{ fix.fix }}</p>
                                    {% if fix.dns_record %}
                                    <div class="code-block small mt-1 border-warning" style="font-size: 0.7rem;">{{ fix.dns_record }}</div>
                                    {% endif %}
                                    <div class="mt-1">
                                        <a href="{{ fix.rfc_url }}" target="_blank" rel="noopener" class="text-muted rfc-link" style="font-size: 0.65rem;">
                                            <i class="fas fa-book me-1"></i>{{ fix.rfc }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Domain Summary Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary border-opacity-25 bg-primary bg-opacity-10">
                    <div class="card-body py-3">
                        <div class="row align-items-center domain-summary-row">
                            <div class="col-6 col-md-3 domain-summary-col mb-2 mb-md-0">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Registrar <span class="text-info">({% if results.registrar_info.get('ns_inferred') %}NS INFERENCE{% elif results.registrar_info.get('status') == 'restricted' %}RESTRICTED{% elif results.registrar_info.source %}{{ results.registrar_info.source|upper }}{% else %}RDAP{% endif %})</span>{% if results.get('_data_freshness', {}).get('registrar', {}).get('source') == 'cached' %} <span class="badge bg-secondary bg-opacity-50 border border-secondary border-opacity-25" style="font-size: 0.55rem; vertical-align: middle;" data-bs-toggle="tooltip" title="{{ results._data_freshness.registrar.note }}">CACHED</span>{% else %} <span class="badge bg-success bg-opacity-25 border border-success border-opacity-25" style="font-size: 0.55rem; vertical-align: middle;" data-bs-toggle="tooltip" title="Live RDAP registry lookup">LIVE</span>{% endif %}</small>
                                <div class="text-truncate" title="{{ results.registrar_info.registrar or results.registrar_info.get('message', 'Unknown') }}">
                                    <i class="fas fa-id-card text-primary me-2"></i>
                                    {% if results.registrar_info.registrar %}
                                    <strong>{{ results.registrar_info.registrar.split('(')[0].strip() }}</strong>
                                    {% elif results.registrar_info.get('status') == 'restricted' %}
                                    <strong class="text-warning">Registry Restricted</strong>
                                    {% else %}
                                    <strong>Unknown</strong>
                                    {% endif %}
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">{% if results.registrar_info.get('ns_inferred') %}Inferred from NS records{% elif results.registrar_info.get('registry_restricted') %}.{{ results.registrar_info.get('registry_restricted_tld', '') }} restricts public WHOIS{% elif results.registrar_info.subdomain_of is defined and results.registrar_info.subdomain_of %}Registrar for {{ results.registrar_info.subdomain_of }}{% else %}Where you pay to own domain{% endif %}</small>
                            </div>
                            <div class="col-6 col-md-3 domain-summary-col mb-2 mb-md-0">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Email Service Provider</small>
                                <div class="text-truncate">
                                    {% set mp_icon = 'ban' if results.get('mail_posture', {}).get('classification', '') in ('no_mail_verified', 'no_mail_partial') else 'question-circle' if results.get('mail_posture', {}).get('classification', '') == 'email_ambiguous' else 'envelope' %}
                                    <i class="fas fa-{{ mp_icon }} text-primary me-2"></i>
                                    <strong>{{ results.hosting_summary.email_hosting if results.hosting_summary and results.hosting_summary.email_hosting else 'Unknown' }}</strong>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">{% if results.get('mail_posture', {}).get('label') %}{{ results.mail_posture.label }}{% elif results.is_no_mail_domain %}Domain declares no email{% else %}Where email is hosted (MX){% endif %}</small>
                            </div>
                            <div class="col-6 col-md-3 domain-summary-col mb-2 mb-md-0">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Web Hosting</small>
                                <div class="text-truncate">
                                    <i class="fas fa-server text-primary me-2"></i>
                                    <strong>{{ results.hosting_summary.hosting if results.hosting_summary else 'Unknown' }}</strong>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">Where website is hosted</small>
                            </div>
                            <div class="col-6 col-md-3 domain-summary-col">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">DNS Hosting</small>
                                <div>
                                    <i class="fas fa-network-wired text-primary me-2"></i>
                                    <strong>{{ results.hosting_summary.dns_hosting if results.hosting_summary else 'Standard' }}</strong>
                                    {% if results.dns_infrastructure and results.dns_infrastructure.provider_tier == 'enterprise' %}
                                    {% if results.dns_infrastructure.is_government %}
                                    <span class="badge bg-info ms-1" style="font-size: 0.55rem;" title="Government security standards apply">Gov</span>
                                    {% endif %}
                                    <span class="badge bg-success ms-1" style="font-size: 0.55rem;" title="Enterprise-grade DNS infrastructure">Enterprise</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">Where DNS records are edited</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-email-security">
            <!-- Email Security Section -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                            <span><i class="fas fa-shield-alt me-2"></i>Email Security</span>
                            <small class="text-muted">Can this domain be impersonated by email?
                                {% if results.posture and results.posture.verdicts.email_answer %}
                                    <span class="badge bg-{{ 'success' if results.posture.verdicts.email_answer == 'No' else 'warning' if 'Mostly' in results.posture.verdicts.email_answer or 'Partially' in results.posture.verdicts.email_answer else 'danger' }} ms-1">{{ results.posture.verdicts.email_answer }}</span>
                                {% endif %}
                            </small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% set mp = results.get('mail_posture', {}) %}
                        {% if mp.get('classification') %}
                            {% if mp.classification == 'no_mail_verified' %}
                            <div class="alert alert-success py-2 mb-3 small border-success border-opacity-50">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-shield-alt me-2"></i><strong>{{ mp.label }}</strong>
                                    <span class="badge bg-success ms-2">{{ mp.present_count }}/{{ mp.total_signals }} controls</span>
                                </div>
                                <div class="mb-2">{{ mp.summary }}</div>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for key, sig in mp.signals.items() %}
                                    {% if sig.present %}
                                    <span class="badge bg-success bg-opacity-75">
                                        <i class="fas fa-check me-1"></i>{{ sig.label }}
                                        <a href="{{ sig.rfc_url }}" target="_blank" rel="noopener" class="text-white-50 text-decoration-none ms-1">({{ sig.rfc }})</a>
                                    </span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% elif mp.classification == 'no_mail_partial' %}
                            <div class="alert alert-warning py-2 mb-3 small border-warning border-opacity-50">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-exclamation-triangle me-2"></i><strong>{{ mp.label }}</strong>
                                    <span class="badge bg-warning text-dark ms-2">{{ mp.present_count }}/{{ mp.total_signals }} controls</span>
                                </div>
                                <div class="mb-2">{{ mp.summary }}</div>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    {% for key, sig in mp.signals.items() %}
                                    {% if sig.present %}
                                    <span class="badge bg-success bg-opacity-75">
                                        <i class="fas fa-check me-1"></i>{{ sig.label }}
                                        <a href="{{ sig.rfc_url }}" target="_blank" rel="noopener" class="text-white-50 text-decoration-none ms-1">({{ sig.rfc }})</a>
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger bg-opacity-75">
                                        <i class="fas fa-times me-1"></i>{{ sig.label }}
                                        <a href="{{ sig.rfc_url }}" target="_blank" rel="noopener" class="text-white-50 text-decoration-none ms-1">({{ sig.rfc }})</a>
                                    </span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% if mp.missing_steps %}
                                <div class="mt-2 pt-2 border-top border-warning border-opacity-25">
                                    <strong class="d-block mb-1"><i class="fas fa-clipboard-list me-1"></i>Missing steps to complete no-mail hardening:</strong>
                                    {% for step in mp.missing_steps %}
                                    <div class="ms-2 mb-1">
                                        <i class="fas fa-arrow-right text-warning me-1"></i>
                                        <strong>{{ step.control }}</strong> &mdash; {{ step.action }}
                                        <a href="{{ step.rfc_url }}" target="_blank" rel="noopener" class="text-muted text-decoration-none ms-1">({{ step.rfc }})</a>
                                        <div class="text-muted ms-3" style="font-size: 0.75rem;"><i class="fas fa-exclamation-circle me-1"></i>{{ step.risk }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if mp.recommended_records %}
                                <div class="mt-2 pt-2 border-top border-warning border-opacity-25">
                                    <strong class="d-block mb-1"><i class="fas fa-code me-1"></i>Recommended DNS records:</strong>
                                    {% for rec in mp.recommended_records %}
                                    <div class="code-block small mb-1">{{ rec }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% elif mp.classification == 'email_ambiguous' %}
                            <div class="alert alert-secondary py-2 mb-3 small border-secondary border-opacity-50">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-question-circle me-2"></i><strong>{{ mp.label }}</strong>
                                </div>
                                <div class="mb-2">{{ mp.summary }}</div>
                                {% if mp.missing_steps %}
                                <div class="mt-2 pt-2 border-top border-secondary border-opacity-25">
                                    <strong class="d-block mb-1"><i class="fas fa-lightbulb me-1"></i>If this domain should not send email, add these DNS records:</strong>
                                    {% for step in mp.missing_steps %}
                                    <div class="ms-2 mb-1">
                                        <i class="fas fa-arrow-right text-secondary me-1"></i>
                                        <strong>{{ step.control }}</strong> &mdash; {{ step.action }}
                                        <a href="{{ step.rfc_url }}" target="_blank" rel="noopener" class="text-muted text-decoration-none ms-1">({{ step.rfc }})</a>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if mp.recommended_records %}
                                <div class="mt-2 pt-2 border-top border-secondary border-opacity-25">
                                    <strong class="d-block mb-1"><i class="fas fa-code me-1"></i>Recommended DNS records:</strong>
                                    {% for rec in mp.recommended_records %}
                                    <div class="code-block small mb-1">{{ rec }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endif %}
                        {% if results.posture and results.posture.verdicts.email %}
                            <div class="alert alert-{{ 'success' if results.posture.verdicts.email_answer == 'No' else 'warning' if 'Mostly' in results.posture.verdicts.email_answer or 'Partially' in results.posture.verdicts.email_answer else 'danger' }} py-2 mb-3 small">
                                <i class="fas fa-gavel me-2"></i><strong>Verdict:</strong> {{ results.posture.verdicts.email }}
                            </div>
                        {% endif %}
                        <div class="row">
                            <!-- SPF Analysis -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center mb-1">
                                    <i class="fas fa-envelope me-2"></i>SPF Record
                                    <a href="https://datatracker.ietf.org/doc/html/rfc7208" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Sender Policy Framework</strong><br>Specifies which mail servers can send email for your domain." aria-label="Learn about SPF - RFC 7208"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 7208</span></a>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if results.spf_analysis.status == 'success' else 'danger' if results.spf_analysis.status == 'error' else 'warning' }}">
                                        {{ results.spf_analysis.status|title }}
                                    </span>
                                    {% if results.spf_analysis.permissiveness %}
                                        <span class="badge bg-{{ 'danger' if results.spf_analysis.permissiveness == 'DANGEROUS' else 'success' if results.spf_analysis.permissiveness in ['STRICT', 'SOFT'] else 'warning' }} ms-1">{{ results.spf_analysis.all_mechanism or '' }}</span>
                                    {% endif %}
                                    {% if results.spf_analysis.lookup_count is defined %}
                                        <span class="badge bg-{{ 'danger' if results.spf_analysis.lookup_count > 10 else 'warning' if results.spf_analysis.lookup_count >= 8 else 'secondary' }} ms-1" data-bs-toggle="tooltip" title="DNS lookup limit is 10">{{ results.spf_analysis.lookup_count }}/10 lookups</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2 small">{{ results.spf_analysis.message }}</p>
                                {% if results.spf_analysis.valid_records %}
                                    {% for record in results.spf_analysis.valid_records %}
                                        <div class="code-block small">{{ record }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if results.spf_analysis.issues %}
                                    <div class="mt-2 small">
                                        {% for issue in results.spf_analysis.issues %}
                                            <div class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.spf_analysis.permissiveness == 'SOFT' %}
                                    <div class="mt-2 p-2 bg-info bg-opacity-10 border border-info border-opacity-25 rounded small">
                                        <i class="fas fa-info-circle text-info me-1"></i>
                                        <strong class="text-info">~all is the industry standard.</strong>
                                        <span class="text-muted">Google, Apple, and most providers default to soft fail. CISA (BOD 18-01) and RFC 7489 §10.1 confirm that DMARC policy — not SPF alone — is the primary enforcement control. Using ~all ensures DKIM can always be evaluated before a DMARC decision is made.
                                        {% if results.dmarc_analysis.policy == 'reject' %}
                                            <strong class="text-success">This domain uses ~all + DMARC reject: the strongest compatible security stance, aligned with CISA and RFC guidance.</strong>
                                        {% elif results.dmarc_analysis.policy == 'quarantine' %}
                                            <strong class="text-warning">This domain uses ~all + DMARC quarantine — good protection. Moving to p=reject would achieve the strongest stance.</strong>
                                        {% elif results.dmarc_analysis.policy == 'none' %}
                                            <strong class="text-danger">This domain has DMARC p=none (monitoring only). Enforcing quarantine or reject is recommended to gain real protection.</strong>
                                        {% elif results.dmarc_analysis.status == 'error' %}
                                            <strong class="text-danger">No DMARC record found. Without DMARC, SPF alone cannot prevent domain spoofing. Adding a DMARC policy is strongly recommended.</strong>
                                        {% endif %}</span>
                                    </div>
                                {% elif results.spf_analysis.permissiveness == 'STRICT' and not results.spf_analysis.no_mail_intent %}
                                    <div class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded small">
                                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                        <strong class="text-warning">SPF hard fail (-all): compliance-strong, but can short-circuit DMARC.</strong>
                                        <span class="text-muted">RFC 7489 §10.1 notes that -all can cause some receivers to reject mail during the SMTP transaction — before DKIM is checked and before DMARC can evaluate the result. A message that would pass DMARC via DKIM alignment may be rejected prematurely. For most domains, ~all + DMARC p=reject is the strongest compatible posture — it ensures every authentication method (SPF, DKIM, DMARC) is fully evaluated before a decision is made.
                                        {% if domain and domain.endswith('.gov') %}
                                            <br><strong class="text-info"><i class="fas fa-landmark me-1"></i>Federal compliance context:</strong> <span class="text-info">CISA BOD 18-01 requires valid SPF records for federal civilian agency domains. The directive doesn't explicitly specify -all vs ~all, but -all is widespread federal practice as defense-in-depth. This domain's use of -all follows that convention.</span>
                                        {% endif %}
                                        {% if results.dmarc_analysis.policy == 'reject' %}
                                            <br><strong class="text-warning">DMARC is set to reject — enforcement is strong. However, some receivers may still reject messages on SPF hard fail before DKIM alignment is checked. {% if not (domain and domain.endswith('.gov')) %}Switching to ~all + p=reject would provide the same enforcement with full DMARC compatibility.{% endif %}</strong>
                                        {% elif results.dmarc_analysis.policy == 'quarantine' %}
                                            <br><strong class="text-warning">DMARC enforcement is partial (quarantine). -all may preempt DKIM/DMARC evaluation at some receivers. Consider p=reject for full enforcement; ~all is more DMARC-compatible.</strong>
                                        {% elif results.dmarc_analysis.policy == 'none' %}
                                            <br><strong class="text-danger">DMARC is monitoring only (p=none). -all provides some SPF-level protection, but DMARC isn't enforcing. Adding p=reject and considering ~all for compatibility would be far more effective.</strong>
                                        {% elif results.dmarc_analysis.status == 'error' %}
                                            <br><strong class="text-danger">No DMARC record found. -all provides strict SPF, but without DMARC, alignment is never evaluated. Adding DMARC with p=reject is strongly recommended.</strong>
                                        {% endif %}</span>
                                    </div>
                                {% endif %}
                                {% if results.spf_analysis.spf_like %}
                                    <div class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning rounded">
                                        <small class="text-warning d-block fw-bold">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Legacy SPF-like records detected
                                        </small>
                                        <small class="text-muted d-block">These deprecated records (e.g. spf2.0/pra) should be ignored per RFC 7208, but some non-compliant receivers may still process them. Consider removing.</small>
                                        {% for record in results.spf_analysis.spf_like %}
                                            <div class="code-block small mt-1 border-warning text-warning">{{ record }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.email_security_mgmt and results.email_security_mgmt.spf_flattening %}
                                    <div class="mt-2 small">
                                        <span class="provider-badge"><i class="fas fa-compress-arrows-alt"></i> SPF flattened by {{ results.email_security_mgmt.spf_flattening.provider }}{% if results.email_security_mgmt.spf_flattening.vendor != results.email_security_mgmt.spf_flattening.provider %} ({{ results.email_security_mgmt.spf_flattening.vendor }}){% endif %}</span>
                                    </div>
                                {% endif %}
                                {% if results.remediation and results.remediation.per_section.spf and results.remediation.per_section.spf.status == 'action_needed' %}
                                    {% set spf_fix = results.remediation.per_section.spf.fixes[0] %}
                                    <div class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded small">
                                        <i class="fas fa-wrench text-warning me-1"></i>
                                        <strong class="text-warning">{{ spf_fix.title }}:</strong>
                                        <span class="text-muted">{{ spf_fix.why|truncate(120) }}</span>
                                        {% if spf_fix.dns_record %}
                                        <div class="code-block small mt-1 border-warning" style="font-size: 0.7rem;">{{ spf_fix.dns_record }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- DMARC Analysis -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center mb-1">
                                    <i class="fas fa-lock me-2"></i>DMARC Policy
                                    <a href="https://datatracker.ietf.org/doc/html/rfc7489" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Domain-based Message Authentication</strong><br>Tells receivers how to handle SPF/DKIM failures and where to send reports." aria-label="Learn about DMARC - RFC 7489"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 7489</span></a>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if results.dmarc_analysis.status == 'success' else 'danger' if results.dmarc_analysis.status == 'error' else 'warning' }}">
                                        {% if results.dmarc_analysis.no_mail_recommendation %}
                                            Recommended
                                        {% else %}
                                            {{ results.dmarc_analysis.status|title }}
                                        {% endif %}
                                    </span>
                                    {% if results.dmarc_analysis.policy %}
                                        <span class="badge bg-{{ 'success' if results.dmarc_analysis.policy == 'reject' else 'warning' if results.dmarc_analysis.policy == 'quarantine' else 'secondary' }} ms-1">p={{ results.dmarc_analysis.policy }}</span>
                                    {% endif %}
                                    {% if results.dmarc_analysis.pct is defined and results.dmarc_analysis.pct < 100 %}
                                        <span class="badge bg-warning ms-1">{{ results.dmarc_analysis.pct }}% enforced</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2 small">{{ results.dmarc_analysis.message }}</p>
                                {% if results.dmarc_analysis.no_mail_recommendation and results.dmarc_analysis.suggested_record %}
                                    <div class="alert alert-info py-2 px-3 mb-2">
                                        <small><i class="fas fa-lightbulb me-1"></i>Add this TXT record at <code>_dmarc.{{ domain }}</code>:</small>
                                        <div class="code-block small mt-1 bg-dark text-success border-success">{{ results.dmarc_analysis.suggested_record }}</div>
                                    </div>
                                {% endif %}
                                {% if results.dmarc_analysis.valid_records %}
                                    {% for record in results.dmarc_analysis.valid_records %}
                                        <div class="code-block small">{{ record }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if results.dmarc_analysis.policy and results.dmarc_analysis.status == 'success' %}
                                    <div class="mt-2 small">
                                        <span class="text-muted">Alignment:</span>
                                        <span class="badge bg-secondary">SPF {{ results.dmarc_analysis.aspf or 'relaxed' }}</span>
                                        <span class="badge bg-secondary">DKIM {{ results.dmarc_analysis.adkim or 'relaxed' }}</span>
                                        {% if results.dmarc_analysis.subdomain_policy %}
                                            <span class="badge bg-{{ 'success' if results.dmarc_analysis.subdomain_policy == 'reject' else 'warning' if results.dmarc_analysis.subdomain_policy == 'quarantine' else 'secondary' }}">sp={{ results.dmarc_analysis.subdomain_policy }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% if results.dmarc_analysis.dmarcbis_tags is defined and results.dmarc_analysis.dmarcbis_tags %}
                                    <div class="mt-2 small">
                                        <span class="text-muted">DMARCbis Tags:</span>
                                        {% if results.dmarc_analysis.np_policy %}
                                            <span class="badge bg-{{ 'success' if results.dmarc_analysis.np_policy == 'reject' else 'warning' if results.dmarc_analysis.np_policy == 'quarantine' else 'secondary' }} ms-1" data-bs-toggle="tooltip" title="Non-existent subdomain policy (draft-ietf-dmarc-dmarcbis) — controls policy for subdomains that don't have their own DMARC record">np={{ results.dmarc_analysis.np_policy }}</span>
                                        {% endif %}
                                        {% if results.dmarc_analysis.t_testing %}
                                            <span class="badge bg-{{ 'warning' if results.dmarc_analysis.t_testing == 'y' else 'success' }} ms-1" data-bs-toggle="tooltip" title="Testing mode (DMARCbis) — replaces pct= tag. t=y means testing/monitoring, t=n means full enforcement">t={{ results.dmarc_analysis.t_testing }}</span>
                                        {% endif %}
                                        {% if results.dmarc_analysis.psd_flag %}
                                            <span class="badge bg-info ms-1" data-bs-toggle="tooltip" title="Public Suffix Domain flag (DMARCbis) — allows public suffix operators (.gov, .edu) to set policy for all domains under them">psd={{ results.dmarc_analysis.psd_flag }}</span>
                                        {% endif %}
                                        <a href="https://datatracker.ietf.org/doc/draft-ietf-dmarc-dmarcbis/" target="_blank" rel="noopener" class="ms-1 text-muted rfc-link small"><span class="rfc-label">DMARCbis</span></a>
                                    </div>
                                {% endif %}
                                {% if results.dmarc_analysis.issues %}
                                    <div class="mt-2 small">
                                        {% for issue in results.dmarc_analysis.issues %}
                                            <div class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.posture.deliberate_monitoring %}
                                    <div class="mt-2 p-2 bg-info bg-opacity-10 border border-info border-opacity-25 rounded small">
                                        <i class="fas fa-flask text-info me-1"></i>
                                        <strong class="text-info">Advanced cryptographic posture detected.</strong>
                                        <span class="text-muted">{{ results.posture.deliberate_monitoring_note }}</span>
                                    </div>
                                {% endif %}
                                {% if results.email_security_mgmt and results.email_security_mgmt.providers %}
                                    {% for provider in results.email_security_mgmt.providers %}
                                        {% if 'DMARC' in provider.detected_from %}
                                            <div class="mt-2 small">
                                                <span class="provider-badge"><i class="fas fa-shield-alt"></i> Reported to {{ provider.name }}{% if provider.vendor != provider.name %} ({{ provider.vendor }}){% endif %}</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if results.remediation and results.remediation.per_section.dmarc and results.remediation.per_section.dmarc.status == 'action_needed' %}
                                    {% set dmarc_fix = results.remediation.per_section.dmarc.fixes[0] %}
                                    <div class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded small">
                                        <i class="fas fa-wrench text-warning me-1"></i>
                                        <strong class="text-warning">{{ dmarc_fix.title }}:</strong>
                                        <span class="text-muted">{{ dmarc_fix.why|truncate(120) }}</span>
                                        {% if dmarc_fix.dns_record %}
                                        <div class="code-block small mt-1 border-warning" style="font-size: 0.7rem;">{{ dmarc_fix.dns_record }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- DKIM Analysis -->
                            <div class="col-md-4">
                                <h6 class="d-flex align-items-center mb-1">
                                    <i class="fas fa-key me-2"></i>DKIM Records
                                    <a href="https://datatracker.ietf.org/doc/html/rfc6376" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>DomainKeys Identified Mail</strong><br>Cryptographic signatures that verify email hasn't been altered in transit." aria-label="Learn about DKIM - RFC 6376"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 6376</span></a>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if results.dkim_analysis.status == 'success' else 'warning' if results.dkim_analysis.status in ['warning', 'partial'] else 'secondary' }}">
                                        {{ 'Found' if results.dkim_analysis.status == 'success' else 'Third-Party Only' if results.dkim_analysis.status == 'partial' else 'Weak Keys' if results.dkim_analysis.status == 'warning' else 'Not Discoverable' }}
                                    </span>
                                    {% if results.dkim_analysis.key_strengths %}
                                        <span class="badge bg-success ms-1">{{ results.dkim_analysis.key_strengths|join(', ') }}</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2 small">{{ results.dkim_analysis.message }}</p>
                                {% if results.dkim_analysis.get('security_gateway') and results.dkim_analysis.get('primary_has_dkim') %}
                                    <div class="alert alert-info py-2 px-3 small mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Mail routed through <strong>{{ results.dkim_analysis.security_gateway }}</strong> (security gateway) — DKIM signed by <strong>{{ results.dkim_analysis.primary_provider }}</strong> (sending platform). This is a standard enterprise architecture.
                                    </div>
                                {% elif results.dkim_analysis.get('third_party_only') and results.dkim_analysis.get('primary_dkim_note') %}
                                    <div class="alert alert-warning py-2 px-3 small mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        {{ results.dkim_analysis.primary_dkim_note }}
                                    </div>
                                {% endif %}
                                {% if results.dkim_analysis.key_issues %}
                                    <div class="mb-2 small">
                                        {% for issue in results.dkim_analysis.key_issues %}
                                            <div class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.dkim_analysis.selectors %}
                                    {% for selector, selector_data in results.dkim_analysis.selectors.items() %}
                                        <div class="mb-2">
                                            <small class="d-block {{ 'text-success' if not results.dkim_analysis.get('third_party_only') or selector_data.get('provider', 'Unknown') == results.dkim_analysis.get('primary_provider', '') else 'text-warning' }}">
                                                <i class="fas fa-check-circle me-1"></i>{{ selector }}
                                                {% if selector_data.get('user_hint') %}
                                                    <span class="badge bg-primary bg-opacity-75 ms-1" title="Found via user-provided selector hint"><i class="fas fa-user me-1"></i>user hint</span>
                                                {% endif %}
                                                {% if selector_data.get('provider') and selector_data.provider != 'Unknown' %}
                                                    <span class="badge bg-{{ 'info' if selector_data.provider == results.dkim_analysis.get('primary_provider', '') else 'secondary' }} ms-1">{{ selector_data.provider }}{% if selector_data.get('inferred') %} (inferred){% endif %}</span>
                                                {% endif %}
                                                {% if selector_data.key_info %}
                                                    {% for ki in selector_data.key_info %}
                                                        {% if ki.key_bits %}
                                                            <span class="badge bg-{{ 'warning' if ki.key_bits < 2048 else 'success' }} ms-1">{{ ki.key_bits }}-bit</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </small>
                                            {% if selector_data.records %}
                                                {% for record in selector_data.records %}
                                                    <div class="code-block small mt-1" style="word-break: break-all;">{{ record }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Second Row: MTA-STS and TLS-RPT -->
                        <div class="row mt-4 pt-3 border-top mta-sts-tlsrpt-row">
                            <!-- MTA-STS Analysis -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-shield-alt me-2"></i>MTA-STS
                                    <a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>SMTP MTA Strict Transport Security</strong><br>Forces TLS encryption between mail servers to prevent downgrade attacks." aria-label="Learn about MTA-STS - RFC 8461"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 8461</span></a>
                                    <span class="badge bg-{{ 'success' if results.mta_sts_analysis.status == 'success' else 'danger' if results.mta_sts_analysis.status == 'error' else 'warning' }} ms-2">
                                        {{ results.mta_sts_analysis.status|title }}
                                    </span>
                                    {% if results.mta_sts_analysis.mode %}
                                        <span class="badge bg-{{ 'success' if results.mta_sts_analysis.mode == 'enforce' else 'warning' }} ms-1">{{ results.mta_sts_analysis.mode|upper }}</span>
                                    {% endif %}
                                    {% if results.mta_sts_analysis.policy_fetched %}
                                        <span class="badge bg-info ms-1" title="Policy file fetched and validated"><i class="fas fa-check-circle"></i> Policy Verified</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.mta_sts_analysis.message }}</p>
                                {% if results.mta_sts_analysis.record %}
                                    <div class="code-block small">{{ results.mta_sts_analysis.record }}</div>
                                {% endif %}
                                {% if results.mta_sts_analysis.policy_fetched %}
                                    <div class="mt-2 small">
                                        <strong>Policy Details:</strong>
                                        <ul class="mb-0 ps-3">
                                            {% if results.mta_sts_analysis.policy_mode %}
                                                <li>Mode: <code>{{ results.mta_sts_analysis.policy_mode }}</code></li>
                                            {% endif %}
                                            {% if results.mta_sts_analysis.policy_max_age %}
                                                <li>Max Age: {{ results.mta_sts_analysis.policy_max_age // 86400 }} days ({{ results.mta_sts_analysis.policy_max_age }} seconds)</li>
                                            {% endif %}
                                            {% if results.mta_sts_analysis.policy_mx %}
                                                <li>MX Patterns: {{ results.mta_sts_analysis.policy_mx|join(', ') }}</li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                {% elif results.mta_sts_analysis.policy_error %}
                                    <div class="mt-2 small text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Policy file: {{ results.mta_sts_analysis.policy_error }}
                                    </div>
                                {% endif %}
                                {% if results.email_security_mgmt and results.email_security_mgmt.providers %}
                                    {% for provider in results.email_security_mgmt.providers %}
                                        {% if 'MTA-STS' in provider.detected_from %}
                                            <div class="mt-2 small">
                                                <span class="provider-badge"><i class="fas fa-shield-alt"></i> Hosted by {{ provider.name }}{% if provider.vendor != provider.name %} ({{ provider.vendor }}){% endif %}</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>

                            <!-- TLS-RPT Analysis -->
                            <div class="col-md-6">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-file-alt me-2"></i>TLS-RPT
                                    <a href="https://datatracker.ietf.org/doc/html/rfc8460" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>TLS Reporting</strong><br>Sends reports about TLS connection failures to help diagnose delivery issues." aria-label="Learn about TLS-RPT - RFC 8460"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 8460</span></a>
                                    <span class="badge bg-{{ 'success' if results.tlsrpt_analysis.status == 'success' else 'danger' if results.tlsrpt_analysis.status == 'error' else 'warning' }} ms-2">
                                        {{ results.tlsrpt_analysis.status|title }}
                                    </span>
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.tlsrpt_analysis.message }}</p>
                                {% if results.tlsrpt_analysis.record %}
                                    <div class="code-block small">{{ results.tlsrpt_analysis.record }}</div>
                                {% endif %}
                                {% if results.email_security_mgmt and results.email_security_mgmt.providers %}
                                    {% for provider in results.email_security_mgmt.providers %}
                                        {% if 'TLS-RPT' in provider.detected_from %}
                                            <div class="mt-2 small">
                                                <span class="provider-badge"><i class="fas fa-shield-alt"></i> Reported to {{ provider.name }}{% if provider.vendor != provider.name %} ({{ provider.vendor }}){% endif %}</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        {% if results.email_security_mgmt and results.email_security_mgmt.actively_managed %}
                        <!-- Email Security Management Stack -->
                        <div class="row mt-4 pt-3 border-top">
                            <div class="col-12">
                                <h6 class="d-flex align-items-center mb-3">
                                    <i class="fas fa-cogs me-2"></i>Email Security Management
                                    <span class="badge bg-success ms-2"><i class="fas fa-check-circle me-1"></i>Actively Managed</span>
                                </h6>
                                <div class="alert alert-info py-2 mb-3 small">
                                    <i class="fas fa-search me-2"></i><strong>Intelligence:</strong> This domain uses dedicated email security management — indicating continuous monitoring and professional oversight, not a "set and forget" configuration. Most tools ignore reporting destinations; we extract the operational security partner network directly from DNS.
                                </div>
                                <div class="row">
                                    {% for provider in results.email_security_mgmt.providers %}
                                    <div class="col-md-6 mb-3">
                                        <div class="border border-secondary rounded p-3 h-100" style="background: rgba(255,255,255,0.03);">
                                            <div class="d-flex align-items-center mb-2">
                                                <strong class="me-2">{{ provider.name }}</strong>
                                                {% if provider.vendor != provider.name %}
                                                    <span class="text-muted small">by {{ provider.vendor }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="mb-2">
                                                {% for source in provider.detected_from %}
                                                    <span class="badge bg-secondary bg-opacity-50 me-1 mb-1">{{ source }}</span>
                                                {% endfor %}
                                            </div>
                                            <div class="small text-muted">
                                                {% for source in provider.sources %}
                                                    <div><i class="fas fa-angle-right me-1"></i>{{ source }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if results.email_security_mgmt.spf_flattening %}
                                <div class="small text-muted mt-1">
                                    <i class="fas fa-compress-arrows-alt me-1"></i><strong>SPF flattening detected:</strong> Dynamic SPF management via {{ results.email_security_mgmt.spf_flattening.provider }} — keeps include count within the 10-lookup limit automatically.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Brand Security Section -->
        <div class="row section-brand-security">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                            <span><i class="fas fa-certificate me-2"></i>Brand Security</span>
                            <small class="text-muted">Can this brand be convincingly faked?
                                {% if results.posture and results.posture.verdicts.brand_secure %}
                                    <span class="badge bg-success ms-1">No</span>
                                {% elif results.posture and results.posture.verdicts.brand %}
                                    <span class="badge bg-warning ms-1">Partially</span>
                                {% endif %}
                            </small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if results.posture and results.posture.verdicts.brand %}
                            <div class="alert alert-{{ 'success' if results.posture.verdicts.brand_secure else 'warning' }} py-2 mb-3 small">
                                <i class="fas fa-gavel me-2"></i><strong>Verdict:</strong> {{ results.posture.verdicts.brand }}
                            </div>
                        {% endif %}
                        <div class="row">
                            <!-- BIMI Analysis -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-image me-2"></i>BIMI
                                    <a href="https://bimigroup.org/implementation-guide/" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Brand Indicators for Message Identification</strong><br>Displays your brand logo next to emails in recipients' inboxes." aria-label="Learn about BIMI - BIMI Group Specification"><i class="fas fa-info-circle"></i><span class="rfc-label">BIMI Spec</span></a>
                                    <span class="badge bg-{{ 'success' if results.bimi_analysis.status == 'success' else 'danger' if results.bimi_analysis.status == 'error' else 'warning' }} ms-2">
                                        {{ results.bimi_analysis.status|title }}
                                    </span>
                                    {% if results.bimi_analysis.vmc_url %}
                                        {% if results.bimi_analysis.vmc_valid %}
                                            <span class="badge bg-success ms-1"><i class="fas fa-certificate me-1"></i>VMC</span>
                                        {% else %}
                                            <span class="badge bg-warning ms-1">VMC</span>
                                        {% endif %}
                                    {% elif results.bimi_analysis.logo_url %}
                                        <span class="badge bg-info ms-1">No VMC</span>
                                    {% endif %}
                                    {% if results.bimi_analysis.logo_valid %}
                                        <span class="badge bg-success ms-1" title="Logo validated"><i class="fas fa-check"></i> {{ results.bimi_analysis.logo_format or 'Logo' }}</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.bimi_analysis.message }}</p>
                                {% if results.bimi_analysis.status == 'success' and not results.bimi_analysis.vmc_url %}
                                    <div class="small text-info mb-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        BIMI works without VMC! VMC (Verified Mark Certificate) requires a registered trademark. Small businesses can use BIMI with just a logo - it shows in Apple Mail and some providers. Gmail requires VMC.
                                    </div>
                                {% elif results.bimi_analysis.vmc_valid %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        VMC certificate accessible{% if results.bimi_analysis.vmc_issuer %} (from {{ results.bimi_analysis.vmc_issuer }}){% endif %} - logo displays in Gmail, Apple Mail, and all major providers.
                                    </div>
                                {% elif results.bimi_analysis.vmc_url %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        VMC certificate found{% if results.bimi_analysis.vmc_error %} - {{ results.bimi_analysis.vmc_error }}{% endif %}
                                    </div>
                                {% endif %}
                                {% if results.bimi_analysis.record %}
                                    <div class="code-block small">{{ results.bimi_analysis.record }}</div>
                                {% endif %}
                                {% if results.bimi_analysis.logo_url %}
                                    <div class="mt-3 d-flex align-items-center">
                                        <div class="me-3 p-2 bg-white rounded" style="flex-shrink: 0; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                                            <img src="{{ url_for('proxy_bimi_logo', url=results.bimi_analysis.logo_url) }}" 
                                                 alt="BIMI Logo" 
                                                 style="width: 48px; height: 48px; object-fit: contain;"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                            <i class="fas fa-image fa-2x text-muted" style="display: none;"></i>
                                        </div>
                                        <div class="small">
                                            {% if results.bimi_analysis.logo_valid %}
                                                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Logo validated ({{ results.bimi_analysis.logo_format or 'SVG' }})</span>
                                            {% elif results.bimi_analysis.logo_error %}
                                                <span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ results.bimi_analysis.logo_error }}</span>
                                            {% else %}
                                                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Logo found</span>
                                            {% endif %}
                                            <a href="{{ results.bimi_analysis.logo_url }}" target="_blank" class="d-block text-info text-truncate" style="max-width: 200px;" title="{{ results.bimi_analysis.logo_url }}">
                                                <i class="fas fa-external-link-alt me-1"></i>View full logo
                                            </a>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- CAA Analysis -->
                            <div class="col-md-6">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-lock me-2"></i>CAA
                                    <a href="https://datatracker.ietf.org/doc/html/rfc8659" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Certificate Authority Authorization</strong><br>Controls which CAs can issue SSL certificates for your domain." aria-label="Learn about CAA - RFC 8659"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 8659</span></a>
                                    <span class="badge bg-{{ 'success' if results.caa_analysis.status == 'success' else 'warning' }} ms-2">
                                        {{ results.caa_analysis.status|title }}
                                    </span>
                                    {% if results.caa_analysis.has_iodef %}
                                        <span class="badge bg-info ms-1">IODEF</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.caa_analysis.message }}</p>
                                {% if results.caa_analysis.issuers %}
                                    <div class="mb-2">
                                        <small class="text-muted">Authorized CAs:</small>
                                        {% for issuer in results.caa_analysis.issuers %}
                                            <span class="badge bg-primary ms-1">{{ issuer }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.caa_analysis.records %}
                                    {% for record in results.caa_analysis.records %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if results.caa_analysis.mpic_note is defined and results.caa_analysis.mpic_note %}
                                    <div class="mt-2 small text-muted">
                                        <i class="fas fa-globe me-1"></i>{{ results.caa_analysis.mpic_note }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- DANE/TLSA Analysis -->
                        {% if results.dane_analysis is defined %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-certificate me-2"></i>DANE / TLSA
                                    <a href="https://datatracker.ietf.org/doc/html/rfc7672" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>DANE for SMTP</strong><br>Publishes TLS certificate information in DNS (TLSA records), enabling mail servers to verify certificates without relying solely on certificate authorities. Requires DNSSEC." aria-label="Learn about DANE - RFC 7672"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 7672</span></a>
                                    <a href="https://datatracker.ietf.org/doc/html/rfc6698" target="_blank" rel="noopener" class="ms-1 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>DANE Protocol</strong><br>DNS-based Authentication of Named Entities — binds TLS certificates to DNS names via TLSA records." aria-label="Learn about DANE - RFC 6698"><span class="rfc-label">RFC 6698</span></a>
                                    <span class="badge bg-{{ 'success' if results.dane_analysis.status == 'success' else 'warning' if results.dane_analysis.status == 'warning' else 'secondary' }} ms-2">
                                        {% if results.dane_analysis.has_dane %}
                                            {{ results.dane_analysis.mx_hosts_with_dane }}/{{ results.dane_analysis.mx_hosts_checked }} MX
                                        {% elif not results.dane_analysis.get('dane_deployable', True) %}
                                            Not Available
                                        {% else %}
                                            Not Configured
                                        {% endif %}
                                    </span>
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.dane_analysis.message }}</p>

                                {% if results.dane_analysis.has_dane and results.dane_analysis.tlsa_records %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-dark small mb-2">
                                            <thead>
                                                <tr>
                                                    <th>MX Host</th>
                                                    <th>Usage</th>
                                                    <th>Selector</th>
                                                    <th>Match</th>
                                                    <th>Certificate Data</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tlsa in results.dane_analysis.tlsa_records %}
                                                <tr>
                                                    <td><code>{{ tlsa.mx_host }}</code></td>
                                                    <td>
                                                        <span class="badge bg-{{ 'success' if tlsa.usage in [2, 3] else 'warning' }}">{{ tlsa.usage }}</span>
                                                        <small class="text-muted ms-1">{{ tlsa.usage_name }}</small>
                                                    </td>
                                                    <td><small>{{ tlsa.selector_name }}</small></td>
                                                    <td><small>{{ tlsa.matching_name }}</small></td>
                                                    <td><code class="small">{{ tlsa.certificate_data }}</code></td>
                                                </tr>
                                                {% if tlsa.recommendation is defined %}
                                                <tr>
                                                    <td colspan="5" class="text-warning small border-0 pt-0"><i class="fas fa-exclamation-triangle me-1"></i>{{ tlsa.recommendation }}</td>
                                                </tr>
                                                {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}

                                {% if results.dane_analysis.issues %}
                                    {% for issue in results.dane_analysis.issues %}
                                        <div class="text-warning small"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                    {% endfor %}
                                {% endif %}

                                {% if results.dane_analysis.has_dane and results.dnssec_analysis.status != 'success' %}
                                    <div class="small text-warning mt-1">
                                        <i class="fas fa-exclamation-triangle me-1"></i>DANE requires DNSSEC to provide its security guarantees (RFC 7672 §1.3). Without DNSSEC validation, TLSA records could be spoofed. Enable DNSSEC to fully benefit from DANE.
                                    </div>
                                {% endif %}
                                {% if not results.dane_analysis.has_dane %}
                                    {% if results.dane_analysis.get('mx_provider') and not results.dane_analysis.get('dane_deployable', True) %}
                                    {% set mx_prov = results.dane_analysis.mx_provider %}
                                    <div class="small mt-1 p-2 rounded" style="background: rgba(255,193,7,0.08); border-left: 3px solid #ffc107;">
                                        {% if mx_prov.get('dane_migration_available') %}
                                        <i class="fas fa-exclamation-circle text-warning me-1"></i><strong>DANE not available on current MX endpoints</strong>
                                        {% else %}
                                        <i class="fas fa-exclamation-circle text-warning me-1"></i><strong>DANE not deployable on {{ mx_prov.provider_name }}</strong>
                                        {% endif %}
                                        <p class="mb-1 mt-1">{{ mx_prov.reason }}</p>
                                        {% if mx_prov.get('alternative') %}
                                        <p class="mb-0"><i class="fas fa-arrow-right me-1"></i><strong>Recommended alternative:</strong> {{ mx_prov.alternative }}{% if results.mta_sts_analysis is defined and results.mta_sts_analysis.status == 'success' %} <span class="text-success">(already configured)</span>{% endif %}</p>
                                        {% endif %}
                                        {% if mx_prov.get('dane_outbound') %}
                                        <p class="mb-0 mt-1 text-muted"><i class="fas fa-info-circle me-1"></i>Note: {{ mx_prov.provider_name }} does validate DANE/TLSA when <em>sending</em> mail to DANE-enabled recipients (outbound DANE).</p>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-info-circle me-1"></i>DANE (<a href="https://datatracker.ietf.org/doc/html/rfc7672" target="_blank" rel="noopener" class="text-info">RFC 7672</a>) binds TLS certificates to DNSSEC-signed DNS records, protecting email transport against man-in-the-middle attacks and rogue CAs. It is the primary transport security standard &mdash; MTA-STS (<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-2" target="_blank" rel="noopener" class="text-info">RFC 8461</a>) was created as the alternative for domains that cannot deploy DNSSEC. Over 1 million domains use DANE globally, including Microsoft Exchange Online, Proton Mail, and Fastmail. Best practice: deploy both for defense in depth.
                                    </div>
                                    {% endif %}
                                {% endif %}

                                {% set has_dane = results.dane_analysis.has_dane %}
                                {% set has_mta_sts = results.mta_sts_analysis is defined and results.mta_sts_analysis.status == 'success' %}
                                {% set has_dnssec = results.dnssec_analysis is defined and results.dnssec_analysis.status == 'success' %}
                                <div class="small mt-2 p-2 rounded" style="background: rgba(255,255,255,0.03); border-left: 3px solid {% if has_dane and has_mta_sts %}#198754{% elif has_dane %}#198754{% elif has_mta_sts %}#0dcaf0{% else %}#6c757d{% endif %};">
                                    <strong><i class="fas fa-balance-scale me-1"></i>Email Transport Security</strong>
                                    <p class="mb-1 mt-1">Two mechanisms protect email in transit. DANE is the primary standard; MTA-STS is the alternative for domains that cannot deploy DNSSEC:</p>
                                    <ul class="mb-1 ps-3">
                                        <li><strong>DNSSEC + DANE</strong> (<a href="https://datatracker.ietf.org/doc/html/rfc7672" target="_blank" rel="noopener" class="text-info">RFC 7672</a>) &mdash; Cryptographic chain of trust from DNS root to mail server certificate. Eliminates reliance on certificate authorities. No trust-on-first-use weakness. Requires DNSSEC.</li>
                                        <li><strong>MTA-STS</strong> (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>) &mdash; HTTPS-based policy requiring TLS for mail delivery. Works without DNSSEC but relies on CA trust and is vulnerable on first use (<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-10" target="_blank" rel="noopener" class="text-info">&sect;10</a>). Created for domains where &ldquo;deploying DNSSEC is undesirable or impractical&rdquo; (<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-2" target="_blank" rel="noopener" class="text-info">&sect;2</a>).</li>
                                    </ul>
                                    {% if has_dane and has_mta_sts %}
                                        <span class="text-success"><i class="fas fa-check-circle me-1"></i><strong>This domain deploys both DANE and MTA-STS &mdash; defense in depth.</strong></span> DANE provides cryptographic certificate binding via DNSSEC, while MTA-STS ensures compatibility with senders that don't validate DNSSEC. Per <a href="https://datatracker.ietf.org/doc/html/rfc8461#section-2" target="_blank" rel="noopener" class="text-info">RFC 8461</a>, DANE takes precedence &mdash; MTA-STS must not override a failing DANE validation.
                                    {% elif has_dane and not has_mta_sts %}
                                        <span class="text-success"><i class="fas fa-check-circle me-1"></i><strong>This domain uses DNSSEC + DANE &mdash; the strongest cryptographic transport security.</strong></span> DANE binds TLS certificates to DNSSEC-signed DNS records, creating a verifiable chain of trust from root to mail server (<a href="https://datatracker.ietf.org/doc/html/rfc7672#section-1.3" target="_blank" rel="noopener" class="text-info">RFC 7672 &sect;1.3</a>). MTA-STS could complement this for senders that don't validate DNSSEC, but DANE alone provides the highest level of protection available.
                                    {% elif has_mta_sts and not has_dane %}
                                        {% if results.dane_analysis.get('mx_provider') and not results.dane_analysis.get('dane_deployable', True) %}
                                        {% if results.dane_analysis.mx_provider.get('dane_migration_available') %}
                                        <span class="text-success"><i class="fas fa-check-circle me-1"></i><strong>This domain uses MTA-STS &mdash; good, but DANE is also available.</strong></span> {{ results.dane_analysis.mx_provider.provider_name }} supports inbound DANE on its newer MX endpoints. This domain's current MX records use legacy endpoints without DANE. Migrating MX records would enable DANE alongside MTA-STS for defense in depth. MTA-STS enforces TLS via HTTPS-based policy (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>).
                                        {% else %}
                                        <span class="text-success"><i class="fas fa-check-circle me-1"></i><strong>This domain uses MTA-STS &mdash; the best available option for {{ results.dane_analysis.mx_provider.provider_name }}.</strong></span> Since {{ results.dane_analysis.mx_provider.provider_name }} does not support inbound DANE, MTA-STS is the strongest transport security this domain can deploy. MTA-STS enforces TLS via HTTPS-based policy, protecting against downgrade attacks (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>).
                                        {% endif %}
                                        {% else %}
                                        <span class="text-info"><i class="fas fa-info-circle me-1"></i><strong>This domain uses MTA-STS without DANE.</strong></span> MTA-STS provides transport security through HTTPS-based policy (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>), but relies on CA trust and is vulnerable on first use. Adding DANE (<a href="https://datatracker.ietf.org/doc/html/rfc7672" target="_blank" rel="noopener" class="text-info">RFC 7672</a>) would provide cryptographic certificate pinning independent of certificate authorities{% if not has_dnssec %} &mdash; this domain would first need to enable DNSSEC{% endif %}.
                                        {% endif %}
                                    {% else %}
                                        {% if results.dane_analysis.get('mx_provider') and not results.dane_analysis.get('dane_deployable', True) %}
                                        {% if results.dane_analysis.mx_provider.get('dane_migration_available') %}
                                        <span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i><strong>This domain has neither DANE nor MTA-STS.</strong></span> {{ results.dane_analysis.mx_provider.provider_name }} supports inbound DANE on its newer MX endpoints, but this domain uses legacy endpoints. Migrate MX records to enable DANE, or deploy MTA-STS (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>) to enforce TLS and protect against downgrade attacks.
                                        {% else %}
                                        <span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i><strong>This domain has neither DANE nor MTA-STS.</strong></span> Since {{ results.dane_analysis.mx_provider.provider_name }} does not support inbound DANE, deploy MTA-STS (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>) to enforce TLS and protect against downgrade attacks.
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted"><i class="fas fa-info-circle me-1"></i><strong>This domain has neither DANE nor MTA-STS.</strong></span> Mail transport relies on opportunistic TLS without policy enforcement, leaving it vulnerable to downgrade attacks. Deploy DANE (<a href="https://datatracker.ietf.org/doc/html/rfc7672" target="_blank" rel="noopener" class="text-info">RFC 7672</a>) with DNSSEC for the strongest protection, or MTA-STS (<a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="text-info">RFC 8461</a>) if DNSSEC is not feasible.
                                        {% endif %}
                                    {% endif %}
                                    <p class="mb-0 mt-1 text-muted" style="font-size: 0.8em;"><i class="fas fa-chart-line me-1"></i><strong>Industry trend:</strong> Microsoft Exchange Online enforces inbound DANE with DNSSEC (GA October 2024), and providers like Proton Mail and Fastmail also support DANE. Google Workspace does not support DANE and relies on MTA-STS. Both mechanisms coexist because DANE is backward-compatible &mdash; senders skip the check if the domain isn't DNSSEC-signed (<a href="https://datatracker.ietf.org/doc/html/rfc7672#section-1.3" target="_blank" rel="noopener" class="text-info">RFC 7672 &sect;1.3</a>).</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Domain Security Section (DNSSEC + NS Delegation) -->
        <div class="row section-domain-security">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                            <span><i class="fas fa-shield-alt me-2"></i>Domain Security</span>
                            <small class="text-muted">Can DNS itself be tampered with?
                                {% if results.posture and results.posture.verdicts.domain_answer %}
                                    <span class="badge bg-{{ 'success' if results.posture.verdicts.domain_answer == 'No' else 'warning' }} ms-1">{{ results.posture.verdicts.domain_answer }}</span>
                                {% endif %}
                            </small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if results.posture and results.posture.verdicts.domain %}
                            <div class="alert alert-{{ 'success' if 'authenticated' in results.posture.verdicts.domain else 'warning' }} py-2 mb-3 small">
                                <i class="fas fa-gavel me-2"></i><strong>Verdict:</strong> {{ results.posture.verdicts.domain }}
                            </div>
                        {% endif %}
                        <div class="row">
                            <!-- DNSSEC Analysis -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center flex-wrap">
                                    <i class="fas fa-key me-2"></i>DNSSEC
                                    <a href="https://datatracker.ietf.org/doc/html/rfc4033" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>DNS Security Extensions</strong><br>Cryptographic signatures that prove DNS responses are authentic and untampered." aria-label="Learn about DNSSEC - RFC 4033-4035"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 4033</span></a>
                                    <span class="badge bg-{{ 'success' if results.dnssec_analysis.status == 'success' else 'warning' }} ms-2">
                                        {% if results.dnssec_analysis.status == 'success' and results.dnssec_analysis.chain_of_trust == 'inherited' %}Inherited{% elif results.dnssec_analysis.status == 'success' %}Signed{% else %}Unsigned{% endif %}
                                    </span>
                                    {% if results.dnssec_analysis.algorithm_name %}
                                        <span class="badge bg-info ms-1 text-break">{{ results.dnssec_analysis.algorithm_name }}</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.dnssec_analysis.message }}</p>
                                
                                {% if results.dnssec_analysis.status == 'success' and results.dnssec_analysis.chain_of_trust == 'inherited' %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        This subdomain is protected by the parent zone's DNSSEC signing.
                                        {% if results.dnssec_analysis.parent_zone %}
                                        DNSSEC at <strong>{{ results.dnssec_analysis.parent_zone }}</strong> covers all records in the zone.
                                        {% endif %}
                                    </div>
                                    {% if results.dnssec_analysis.ad_flag %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>AD Flag:</strong> <span class="badge bg-success">Validated</span>
                                        <span class="text-muted">- Resolver ({{ results.dnssec_analysis.ad_resolver }}) confirmed cryptographic signatures</span>
                                    </div>
                                    {% endif %}
                                {% elif results.dnssec_analysis.status == 'success' %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Chain of trust: Root → TLD → Domain. DNS responses are authenticated and tamper-proof.
                                    </div>
                                    {% if results.dnssec_analysis.ad_flag %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>AD Flag:</strong> <span class="badge bg-success">Validated</span>
                                        <span class="text-muted">- Resolver ({{ results.dnssec_analysis.ad_resolver }}) confirmed cryptographic signatures</span>
                                    </div>
                                    {% else %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>AD Flag:</strong> <span class="badge bg-warning text-dark">Not Set</span>
                                        <span class="text-muted">- Records exist but resolver didn't confirm validation</span>
                                    </div>
                                    {% endif %}
                                {% elif results.dnssec_analysis.chain_of_trust == 'broken' %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        DNSKEY exists but DS record not published at registrar. Add DS record to complete chain of trust.
                                    </div>
                                {% else %}
                                    {% if results.dns_infrastructure and results.dns_infrastructure.explains_no_dnssec %}
                                    <div class="small text-info mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>Alternative Security:</strong> {{ results.dns_infrastructure.provider }} provides enterprise-grade DNS with DDoS protection and monitoring.
                                    </div>
                                    {% if results.dns_infrastructure.alt_security_items %}
                                    <div class="small text-muted mb-2">
                                        <i class="fas fa-check me-1"></i>
                                        {% for item in results.dns_infrastructure.alt_security_items %}
                                            {{ item }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <div class="small text-muted mb-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Domain does not use DNSSEC. Enable in your registrar's DNS settings (look for "DNSSEC" or "DS records" section).
                                    </div>
                                    {% endif %}
                                {% endif %}
                                
                                {% if results.dnssec_analysis.ds_records %}
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">DS Record (at registrar):</small>
                                        {% for ds in results.dnssec_analysis.ds_records %}
                                            <div class="code-block small mb-1" style="font-size: 0.7rem;">{{ ds }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- NS Delegation Analysis -->
                            <div class="col-md-6">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-project-diagram me-2"></i>NS Delegation
                                    <span class="badge bg-{{ 'success' if results.ns_delegation_analysis.status == 'success' else 'warning' if results.ns_delegation_analysis.status == 'warning' else 'secondary' }} ms-2">
                                        {% if results.ns_delegation_analysis.is_subdomain is defined and results.ns_delegation_analysis.is_subdomain %}Subdomain{% elif results.ns_delegation_analysis.delegation_ok %}Verified{% else %}Check Failed{% endif %}
                                    </span>
                                    {% if results.ns_delegation_analysis.match == true %}
                                        <span class="badge bg-success ms-1">Match</span>
                                    {% elif results.ns_delegation_analysis.match == false %}
                                        <span class="badge bg-warning ms-1">Mismatch</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.ns_delegation_analysis.message }}</p>
                                
                                {% if results.ns_delegation_analysis.is_subdomain is defined and results.ns_delegation_analysis.is_subdomain %}
                                    <div class="small text-info mb-2">
                                        <i class="fas fa-sitemap me-1"></i>
                                        DNS records managed within the <strong>{{ results.ns_delegation_analysis.parent_zone }}</strong> zone. No separate NS delegation required.
                                    </div>
                                {% elif results.ns_delegation_analysis.match == false %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        NS records at domain differ from parent zone delegation. May indicate recent DNS migration still propagating.
                                    </div>
                                {% elif results.ns_delegation_analysis.match == true %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Parent zone delegation matches domain's NS records. No delegation drift detected.
                                    </div>
                                {% endif %}
                                
                                {% if results.ns_delegation_analysis.child_ns %}
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">Nameservers:</small>
                                        {% for ns in results.ns_delegation_analysis.child_ns %}
                                            <span class="badge bg-secondary me-1 mb-1">{{ ns }}</span>
                                        {% endfor %}
                                    </div>
                                {% elif results.ns_delegation_analysis.is_subdomain is defined and results.ns_delegation_analysis.is_subdomain and results.ns_delegation_analysis.parent_ns %}
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">Parent zone nameservers ({{ results.ns_delegation_analysis.parent_zone }}):</small>
                                        {% for ns in results.ns_delegation_analysis.parent_ns %}
                                            <span class="badge bg-secondary me-1 mb-1">{{ ns }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Multi-Resolver Consensus -->
                        {% if results.resolver_consensus %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex align-items-center small">
                                    <i class="fas fa-check-double me-2 text-{{ 'success' if results.resolver_consensus.consensus_reached else 'warning' }}"></i>
                                    <span class="text-muted">
                                        <strong>Multi-Resolver Verification:</strong>
                                        {% if results.resolver_consensus.consensus_reached %}
                                            <span class="text-success">Consensus reached</span> - 
                                            {{ results.resolver_consensus.resolvers_queried }} resolvers (Cloudflare, Google, Quad9, OpenDNS) agree on DNS records
                                        {% else %}
                                            <span class="text-warning">Discrepancy detected</span> - 
                                            Some resolvers returned different results
                                            {% if results.resolver_consensus.discrepancies %}
                                                <a href="#resolver-discrepancies" class="text-warning">({{ results.resolver_consensus.discrepancies|length }} difference{{ 's' if results.resolver_consensus.discrepancies|length > 1 else '' }} found)</a>
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Discrepancy Details (shown when there are differences) -->
                        {% if not results.resolver_consensus.consensus_reached and results.resolver_consensus.discrepancies %}
                        <div class="row mt-2" id="resolver-discrepancies">
                            <div class="col-12">
                                <div class="p-2 bg-warning bg-opacity-10 border border-warning rounded small">
                                    <strong class="text-warning d-block mb-1"><i class="fas fa-exclamation-triangle me-1"></i>Resolver Differences:</strong>
                                    {% for disc in results.resolver_consensus.discrepancies %}
                                    <div class="mb-1 text-muted">
                                        <i class="fas fa-angle-right me-1"></i>{{ disc }}
                                    </div>
                                    {% endfor %}
                                    <small class="text-muted d-block mt-1">This may indicate DNS propagation in progress or geo-based DNS routing.</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic & Routing Section -->
        <div class="row section-traffic-routing">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-route me-2"></i>Traffic & Routing
                            <small class="text-muted ms-2">Where traffic flows &amp; how services resolve</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- A Records (IPv4) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-primary me-2">A</span>IPv4 Address
                                </h6>
                                {% if results.basic_records.A %}
                                    {% for record in results.basic_records.A %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    <small class="text-muted">Where the domain points for web traffic</small>
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No A records</div>
                                    <small class="text-info">Domain may use AAAA (IPv6) only or CNAME</small>
                                {% endif %}
                            </div>

                            <!-- AAAA Records (IPv6) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-info me-2">AAAA</span>IPv6 Address
                                </h6>
                                {% if results.basic_records.AAAA %}
                                    {% for record in results.basic_records.AAAA %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    <small class="text-success"><i class="fas fa-check me-1"></i>IPv6 ready</small>
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No AAAA records</div>
                                    <small class="text-muted">IPv6 not configured</small>
                                {% endif %}
                            </div>

                            <!-- MX Records (Mail) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-warning text-dark me-2">MX</span>Mail Servers
                                </h6>
                                {% if results.basic_records.MX %}
                                    {% if results.has_null_mx %}
                                        {% for record in results.basic_records.MX %}
                                            <div class="code-block small mb-1">{{ record }}</div>
                                        {% endfor %}
                                        <div class="mt-1">
                                            <span class="badge bg-info bg-opacity-75"><i class="fas fa-ban me-1"></i>Null MX</span>
                                            <a href="https://datatracker.ietf.org/doc/html/rfc7505" target="_blank" rel="noopener" class="ms-1 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Null MX</strong><br>An explicit declaration that this domain does not accept email. Priority 0 with a dot (.) as the mail server." aria-label="Learn about Null MX - RFC 7505"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 7505</span></a>
                                        </div>
                                        <small class="text-info">Domain explicitly does not accept email</small>
                                    {% else %}
                                        {% set mx_list = results.basic_records.MX|join(' ')|lower %}
                                        {% set is_google = 'google' in mx_list or 'googlemail' in mx_list %}
                                        {% set mx_count = results.basic_records.MX|length %}
                                        {% for record in results.basic_records.MX %}
                                            <div class="code-block small mb-1">{{ record }}</div>
                                        {% endfor %}
                                        {% if is_google and mx_count > 1 %}
                                            <div class="text-warning small mt-1">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                <strong>Legacy setup:</strong> Google Workspace now only needs 1 MX record (smtp.google.com). You can simplify by removing the extra {{ mx_count - 1 }} record{{ 's' if mx_count > 2 else '' }}.
                                            </div>
                                        {% else %}
                                            <small class="text-muted">Priority + mail server for email delivery</small>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No MX records</div>
                                    <small class="text-warning">Domain cannot receive email</small>
                                {% endif %}
                            </div>

                            <!-- SRV Records (Services) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-secondary me-2">SRV</span>Services
                                </h6>
                                {% if results.basic_records.SRV %}
                                    {% for record in results.basic_records.SRV %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    <small class="text-muted">SIP, XMPP, or other service endpoints</small>
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No SRV records</div>
                                    <small class="text-muted">No service-specific routing configured</small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Summary bar -->
                        <div class="border-top pt-3 mt-2">
                            <div class="d-flex flex-wrap gap-3 small">
                                <span>
                                    <i class="fas fa-globe me-1 text-primary"></i>
                                    <strong>Web:</strong>
                                    {% if results.basic_records.A or results.basic_records.AAAA %}
                                        <span class="text-success">Reachable</span>
                                        ({{ results.basic_records.A|length if results.basic_records.A else 0 }} IPv4, {{ results.basic_records.AAAA|length if results.basic_records.AAAA else 0 }} IPv6)
                                    {% else %}
                                        <span class="text-warning">No direct IP</span>
                                    {% endif %}
                                </span>
                                <span>
                                    <i class="fas fa-envelope me-1 text-warning"></i>
                                    <strong>Mail:</strong>
                                    {% if results.has_null_mx %}
                                        <span class="text-info">Null MX (no mail)</span>
                                    {% elif results.basic_records.MX %}
                                        <span class="text-success">{{ results.basic_records.MX|length }} server{{ 's' if results.basic_records.MX|length > 1 else '' }}</span>
                                    {% else %}
                                        <span class="text-danger">Not configured</span>
                                    {% endif %}
                                </span>
                                <span>
                                    <i class="fas fa-cogs me-1 text-secondary"></i>
                                    <strong>Services:</strong>
                                    {% if results.basic_records.SRV %}
                                        <span class="text-success">{{ results.basic_records.SRV|length }} endpoint{{ 's' if results.basic_records.SRV|length > 1 else '' }}</span>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Propagation Delta Summary -->
        {% set propagating_types = [] %}
        {% set synced_count = 0 %}
        {% if results.propagation_status %}
            {% for rtype, pinfo in results.propagation_status.items() %}
                {% if pinfo.status == 'propagating' %}
                    {% set _ = propagating_types.append(rtype) %}
                {% elif pinfo.status == 'synchronized' %}
                    {% set synced_count = synced_count + 1 %}
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <div class="row mb-3">
            <div class="col-12">
                {% if propagating_types %}
                <div class="alert alert-warning py-2 mb-0 d-flex align-items-center justify-content-between flex-wrap">
                    <div>
                        <i class="fas fa-sync-alt fa-spin me-2"></i>
                        <strong>Δ Changes Detected:</strong>
                        {% for rtype in propagating_types %}
                            <span class="badge bg-warning text-dark ms-1">{{ rtype }}</span>
                        {% endfor %}
                        <span class="ms-2 small text-muted">Resolver ≠ Authoritative (TTL / CDN rotation / recent change)</span>
                    </div>
                    <small class="text-warning-emphasis">
                        <i class="fas fa-clock me-1"></i>Risk: Low - typically resolves within TTL
                    </small>
                </div>
                {% else %}
                <div class="alert alert-success py-2 mb-0 d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Δ No Propagation Issues:</strong>
                    <span class="ms-2 small">All DNS records are synchronized between resolver and authoritative nameserver.</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Live DNS Diff Feature Callout -->
        <div class="card bg-dark border-info mb-4">
            <div class="card-body py-3">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="badge bg-info text-dark px-3 py-2" style="font-size: 0.9rem;">
                            <i class="fas fa-code-compare me-2"></i>Live DNS Diff
                        </span>
                    </div>
                    <div>
                        <strong class="text-info">Real-time propagation comparison</strong>
                        <span class="text-muted ms-2">|</span>
                        <span class="text-light ms-2">See exactly what public resolvers return vs. what your authoritative nameserver has. Spot propagation delays, stale cache, and DNS misconfigurations instantly.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- DNS Diff Section - True Side-by-Side Comparison -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-code-compare me-2"></i>DNS Evidence Diff
                        <small class="text-muted ms-2">Side-by-side comparison</small>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- Diff Header Row -->
                    <div class="dns-diff-container">
                        <div class="dns-diff-header">
                            <div class="dns-diff-col dns-diff-left">
                                <i class="fas fa-database me-2"></i>Resolver Records
                                <small class="opacity-75">(Public DNS cache)</small>
                            </div>
                            <div class="dns-diff-col dns-diff-right">
                                <i class="fas fa-microchip me-2"></i>Authoritative Records
                                <small class="opacity-75">(Source of truth)</small>
                            </div>
                        </div>
                        
                        {% for record_type in results.basic_records.keys() %}
                            {% set resolver_records = results.basic_records.get(record_type, []) %}
                            {% set auth_records = results.authoritative_records.get(record_type, []) if results.authoritative_records else [] %}
                            {% set max_len = [resolver_records|length, auth_records|length]|max %}
                            
                            {% if max_len > 0 or record_type in ['A', 'AAAA', 'MX', 'NS', 'TXT', 'CAA', 'SOA', 'DMARC', 'MTA-STS', 'TLS-RPT'] %}
                                <!-- Record Type Header -->
                                <div class="dns-diff-type-header">
                                    <span class="badge bg-secondary me-2">{{ record_type }}</span>
                                    {% if record_type == 'DMARC' %}<small class="text-muted me-1">_dmarc.{{ domain }}</small>
                                        <a href="https://datatracker.ietf.org/doc/html/rfc7489" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="Domain-based Message Authentication, Reporting, and Conformance">RFC 7489</a>
                                    {% elif record_type == 'MTA-STS' %}<small class="text-muted me-1">_mta-sts.{{ domain }}</small>
                                        <a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="SMTP MTA Strict Transport Security">RFC 8461</a>
                                    {% elif record_type == 'TLS-RPT' %}<small class="text-muted me-1">_smtp._tls.{{ domain }}</small>
                                        <a href="https://datatracker.ietf.org/doc/html/rfc8460" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="SMTP TLS Reporting">RFC 8460</a>
                                    {% elif record_type == 'CAA' %}
                                        <a href="https://datatracker.ietf.org/doc/html/rfc8659" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="DNS Certification Authority Authorization">RFC 8659</a>
                                    {% elif record_type == 'SOA' %}
                                        <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-3.3.13" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="Start of Authority record">RFC 1035</a>
                                    {% elif record_type == 'MX' %}
                                        <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-5" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="Mail Exchange record">RFC 5321</a>
                                    {% elif record_type == 'TXT' %}
                                        <a href="https://datatracker.ietf.org/doc/html/rfc7208" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="Sender Policy Framework">RFC 7208</a>
                                    {% elif record_type == 'NS' %}
                                        <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-3.3.11" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal" style="font-size: 0.6rem;" title="Name Server record">RFC 1035</a>
                                    {% endif %}
                                    {% if results.propagation_status and record_type in results.propagation_status %}
                                        {% set p_info = results.propagation_status[record_type] %}
                                        {% if p_info.status == 'synchronized' %}
                                            <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-check-double me-1"></i>Synchronized
                                            </span>
                                        {% elif p_info.status == 'propagating' %}
                                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-clock me-1"></i>Propagating
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <span class="ms-auto text-muted small d-flex align-items-center gap-2">
                                        {% set r_ttl = results.resolver_ttl.get(record_type) if results.resolver_ttl else none %}
                                        {% set a_ttl = results.auth_ttl.get(record_type) if results.auth_ttl else none %}
                                        {% if r_ttl is not none or a_ttl is not none %}
                                            {% set ttl_val = r_ttl if r_ttl is not none else a_ttl %}
                                            <span class="badge bg-dark bg-opacity-50 fw-normal" style="font-size: 0.65rem;" title="Time-to-live: how long resolvers cache this record">TTL {{ ttl_val }}s</span>
                                        {% endif %}
                                        {{ resolver_records|length }} / {{ auth_records|length }} records
                                        {% set hdr_auth_status = results.auth_query_status.get(record_type, '') if results.auth_query_status else '' %}
                                        {% if hdr_auth_status == 'timeout' %}
                                            <span class="text-warning-emphasis" title="Authoritative nameserver timed out"><i class="fas fa-clock"></i></span>
                                        {% elif hdr_auth_status in ('error', 'servfail') %}
                                            <span class="text-warning-emphasis" title="Authoritative query failed"><i class="fas fa-exclamation-triangle"></i></span>
                                        {% endif %}
                                    </span>
                                </div>
                                
                                <!-- Record Rows -->
                                {% set auth_status = results.auth_query_status.get(record_type, '') if results.auth_query_status else '' %}
                                {% set auth_unavailable = auth_status in ('timeout', 'error', 'servfail') %}
                                {% if max_len > 0 %}
                                    {% for i in range(max_len) %}
                                        {% set resolver_val = resolver_records[i] if i < resolver_records|length else none %}
                                        {% set auth_val = auth_records[i] if i < auth_records|length else none %}
                                        {% set is_match = resolver_val == auth_val %}
                                        
                                        <div class="dns-diff-row {% if not is_match and resolver_val and auth_val %}dns-diff-changed{% elif not resolver_val %}dns-diff-added{% elif not auth_val and not auth_unavailable %}dns-diff-removed{% endif %}">
                                            <div class="dns-diff-col dns-diff-left {% if not resolver_val %}dns-diff-empty{% elif not is_match and not auth_unavailable %}dns-diff-highlight-old{% endif %}">
                                                {% if resolver_val %}
                                                    <code class="dns-diff-value">{{ resolver_val }}</code>
                                                {% else %}
                                                    <span class="dns-diff-placeholder">—</span>
                                                {% endif %}
                                            </div>
                                            <div class="dns-diff-col dns-diff-right {% if not auth_val %}dns-diff-empty{% elif not is_match %}dns-diff-highlight-new{% endif %}">
                                                {% if auth_val %}
                                                    <code class="dns-diff-value">{{ auth_val }}</code>
                                                {% elif auth_unavailable %}
                                                    <span class="dns-diff-placeholder text-warning-emphasis"><i class="fas fa-clock me-1"></i>{{ 'Timeout' if auth_status == 'timeout' else 'Unavailable' }}</span>
                                                {% else %}
                                                    <span class="dns-diff-placeholder">—</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="dns-diff-row">
                                        <div class="dns-diff-col dns-diff-left dns-diff-empty">
                                            <span class="dns-diff-placeholder">No records</span>
                                        </div>
                                        <div class="dns-diff-col dns-diff-right dns-diff-empty">
                                            <span class="dns-diff-placeholder">No records</span>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if not results.authoritative_records or results.authoritative_records.values()|map('length')|sum == 0 %}
                            <div class="dns-diff-notice">
                                <i class="fas fa-info-circle me-2"></i>
                                Authoritative records unavailable - nameserver may be blocking direct queries
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Subdomain Discovery (Certificate Transparency) -->
        {% set ct = results.get('ct_subdomains', {}) %}
        <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex align-items-center">
                    <h5 class="mb-0 flex-grow-1">
                        <i class="fas fa-sitemap me-2"></i>Subdomain Discovery
                        <a href="https://datatracker.ietf.org/doc/html/rfc6962" target="_blank" rel="noopener" class="badge bg-dark bg-opacity-25 text-muted text-decoration-none fw-normal ms-2" style="font-size: 0.6rem;" title="Certificate Transparency">RFC 6962</a>
                        {% if results.get('_data_freshness', {}).get('ct_subdomains', {}).get('source') == 'cache' %}<span class="badge bg-secondary bg-opacity-50 border border-secondary border-opacity-25 ms-1" style="font-size: 0.55rem;" data-bs-toggle="tooltip" title="CT log data cached for 1 hour — certificate records change infrequently">CACHED</span>{% else %}<span class="badge bg-success bg-opacity-25 border border-success border-opacity-25 ms-1" style="font-size: 0.55rem;" data-bs-toggle="tooltip" title="Live Certificate Transparency query">LIVE</span>{% endif %}
                    </h5>
                    {% if ct.get('status') == 'success' and ct.get('unique_subdomains', 0) > 0 %}
                    <span class="badge bg-info-subtle text-info border border-info-subtle">{% if ct.get('was_truncated') %}{{ ct.display_count }} of {% endif %}{{ ct.unique_subdomains }} subdomain{{ 's' if ct.unique_subdomains != 1 else '' }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if ct.get('status') == 'success' and ct.get('subdomains') and ct.subdomains|length > 0 %}
                    <div class="mb-3">
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                            <span class="badge bg-info-subtle text-info border border-info-subtle"><i class="fas fa-certificate me-1"></i>{{ ct.total_certs }} certificates analyzed</span>
                            <span class="badge bg-success-subtle text-success border border-success-subtle"><i class="fas fa-check me-1"></i>{{ ct.get('current_count', 0) }} current</span>
                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle"><i class="fas fa-history me-1"></i>{{ ct.get('expired_count', 0) }} expired</span>
                            {% if ct.get('cname_count', 0) > 0 %}
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle"><i class="fas fa-link me-1"></i>{{ ct.cname_count }} CNAME{{ 's' if ct.cname_count != 1 else '' }}</span>
                            {% endif %}
                            {% if ct.get('cname_discovered_count', 0) > 0 %}
                            <span class="badge border" style="font-size:0.7rem; color: #a855f7; background: rgba(168,85,247,0.1); border-color: rgba(168,85,247,0.25) !important;"><i class="fas fa-project-diagram me-1"></i>{{ ct.cname_discovered_count }} discovered via CNAME</span>
                            {% endif %}
                            {% if ct.get('providers_found', 0) > 0 %}
                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle"><i class="fas fa-building me-1"></i>{{ ct.providers_found }} provider{{ 's' if ct.providers_found != 1 else '' }} identified</span>
                            {% endif %}
                            <span class="badge bg-dark bg-opacity-25 text-muted fw-normal"><i class="fas fa-database me-1"></i>Source: {{ ct.source }}</span>
                        </div>
                        <small class="text-muted"><i class="fas fa-info-circle me-1"></i>{{ ct.caveat }}</small>
                        {% if ct.get('wildcard_certs', {}).get('present') %}
                        <div class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25 py-2 mt-2 mb-0 small">
                            <i class="fas fa-asterisk me-1"></i>
                            <strong>Wildcard certificate detected:</strong> <code>{{ ct.wildcard_certs.pattern }}</code>
                            {% if ct.wildcard_certs.current %}
                            <span class="badge bg-success-subtle text-success border border-success-subtle ms-1" style="font-size:0.65rem;">Active</span>
                            {% else %}
                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-1" style="font-size:0.65rem;">Expired</span>
                            {% endif %}
                            <div class="mt-1 text-muted">
                                Subdomains covered by this wildcard won't appear individually in CT logs (RFC 6962). DNS probing and CNAME chain traversal were used to discover additional subdomains below.
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% if ct.get('provider_summary') and ct.provider_summary|length > 0 %}
                    <div class="alert alert-warning bg-warning bg-opacity-10 border-warning border-opacity-25 py-2 mt-2 mb-3 small">
                        <i class="fas fa-building me-1"></i>
                        <strong>Third-party services detected via CNAME:</strong>
                        <div class="d-flex flex-wrap gap-1 mt-2">
                            {% set categories = {} %}
                            {% for pname, pdata in ct.provider_summary.items() %}
                            {% set cat = pdata.get('category', 'Other') %}
                            {% if cat not in categories %}{% if categories.update({cat: []}) %}{% endif %}{% endif %}
                            {% if categories[cat].append(pdata) %}{% endif %}
                            {% endfor %}
                            {% for cat, providers in categories|items %}
                            {% for pdata in providers %}
                            <span class="badge bg-{{ 'primary' if cat in ('Cloud', 'CDN', 'PaaS') else 'success' if cat in ('Website', 'Hosting') else 'info' if cat in ('Email', 'Support', 'Collaboration') else 'warning' if cat in ('Marketing', 'Analytics') else 'danger' if cat in ('Security', 'Identity') else 'secondary' }}-subtle text-{{ 'primary' if cat in ('Cloud', 'CDN', 'PaaS') else 'success' if cat in ('Website', 'Hosting') else 'info' if cat in ('Email', 'Support', 'Collaboration') else 'warning' if cat in ('Marketing', 'Analytics') else 'danger' if cat in ('Security', 'Identity') else 'secondary' }} border border-{{ 'primary' if cat in ('Cloud', 'CDN', 'PaaS') else 'success' if cat in ('Website', 'Hosting') else 'info' if cat in ('Email', 'Support', 'Collaboration') else 'warning' if cat in ('Marketing', 'Analytics') else 'danger' if cat in ('Security', 'Identity') else 'secondary' }}-subtle" data-bs-toggle="tooltip" title="{{ cat }} — {{ pdata.subdomains|join(', ') }}">{{ pdata.name }} <span class="opacity-75">({{ cat }})</span></span>
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="border-secondary">Subdomain</th>
                                    <th class="border-secondary text-center">Source</th>
                                    <th class="border-secondary text-center">Status</th>
                                    <th class="border-secondary">Provider / CNAME</th>
                                    <th class="border-secondary text-center">Certificates</th>
                                    <th class="border-secondary">First Seen</th>
                                    <th class="border-secondary">Issuer(s)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sub in ct.subdomains %}
                                <tr>
                                    <td class="border-secondary">
                                        <code class="small">{{ sub.name }}</code>
                                        {% if sub.is_wildcard %}
                                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle" style="font-size:0.6rem;">Wildcard</span>
                                        {% endif %}
                                    </td>
                                    <td class="border-secondary text-center">
                                        {% if sub.get('source') == 'dns' %}
                                        <span class="badge bg-info-subtle text-info border border-info-subtle" style="font-size:0.6rem;" title="Found via DNS A/AAAA record lookup of common service names">DNS</span>
                                        {% elif sub.get('source') == 'cname' %}
                                        <span class="badge bg-purple-subtle text-purple border border-purple-subtle" style="font-size:0.6rem; --bs-purple: #a855f7; color: #a855f7 !important; background: rgba(168,85,247,0.1) !important; border-color: rgba(168,85,247,0.25) !important;" title="Discovered as intermediate hop in CNAME chain from {{ sub.get('discovered_via', 'another subdomain') }}">CNAME</span>
                                        {% else %}
                                        <span class="badge bg-dark bg-opacity-25 text-muted" style="font-size:0.6rem;" title="Found in Certificate Transparency logs (RFC 6962)">CT Log</span>
                                        {% endif %}
                                    </td>
                                    <td class="border-secondary text-center">
                                        {% if sub.is_current %}
                                        <span class="badge bg-success-subtle text-success border border-success-subtle" style="font-size:0.7rem;">Current</span>
                                        {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle" style="font-size:0.7rem;">Expired</span>
                                        {% endif %}
                                    </td>
                                    <td class="border-secondary">
                                        {% if sub.get('provider') %}
                                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle" style="font-size:0.65rem;" data-bs-toggle="tooltip" title="CNAME chain: {{ sub.name }} → {{ sub.get('cname_chain', [])|join(' → ') }}">
                                            <i class="fas fa-building me-1"></i>{{ sub.provider }}
                                        </span>
                                        <span class="d-block text-muted" style="font-size:0.6rem;">{{ sub.get('provider_category', '') }}</span>
                                        {% elif sub.get('cname_target') %}
                                        <span class="text-muted small" data-bs-toggle="tooltip" title="CNAME chain: {{ sub.name }} → {{ sub.get('cname_chain', [])|join(' → ') }}">
                                            <i class="fas fa-link me-1" style="font-size:0.6rem;"></i><code style="font-size:0.65rem;">{{ sub.cname_target }}</code>
                                        </span>
                                        {% else %}
                                        <span class="small text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="border-secondary text-center"><span class="small text-muted">{{ sub.cert_count if sub.cert_count else '—' }}</span></td>
                                    <td class="border-secondary"><span class="small text-muted">{{ sub.first_seen if sub.first_seen else '—' }}</span></td>
                                    <td class="border-secondary"><span class="small text-muted">{{ sub.issuers|join(', ') if sub.issuers else ('Wildcard (*.%s)'|format(domain) if sub.get('source') == 'dns' else ('via ' + sub.get('discovered_via', '') if sub.get('source') == 'cname' and sub.get('discovered_via') else '')) }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if ct.get('was_truncated') %}
                    <div class="text-muted small mt-2 mb-0 p-2 rounded" style="background: rgba(255,255,255,0.03);">
                        <i class="fas fa-filter me-1"></i><strong>Showing {{ ct.display_count }} of {{ ct.unique_subdomains }} subdomains</strong> &mdash; curated by security relevance.
                        Three cooperative discovery methods — CT logs (RFC 6962), DNS probing of ~290 common service names, and CNAME chain traversal — feed into a unified view.
                        Well-known service names (mail, vpn, api, sso, admin, etc.), DNS-resolving hosts, and subdomains with the most certificate activity are prioritized.
                        {% if ct.expired_count > 0 %}
                        <span class="ms-1">{{ ct.expired_count }} expired-certificate-only subdomain{{ 's' if ct.expired_count != 1 else '' }} {{ 'mostly omitted' if ct.expired_count > ct.display_count else 'included where relevant' }}.</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% elif ct.get('status') == 'success' and ct.get('unique_subdomains', 0) == 0 %}
                    {% if ct.get('is_analyzed_subdomain') and ct.get('registered_domain') %}
                    <div class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25 mb-0 small">
                        <div class="mb-2">
                            <i class="fas fa-project-diagram me-1"></i>
                            <strong>{{ domain }}</strong> is itself a subdomain of <strong>{{ ct.registered_domain }}</strong>.
                        </div>
                        <p class="mb-2">
                            Certificate Transparency logs record certificates by fully qualified domain name
                            (<a href="https://datatracker.ietf.org/doc/html/rfc8499#section-2" target="_blank" rel="noopener" class="text-info">RFC 8499</a>).
                            This search queried for names beneath <code>{{ domain }}</code> in the DNS hierarchy
                            (<a href="https://datatracker.ietf.org/doc/html/rfc1034#section-3.1" target="_blank" rel="noopener" class="text-info">RFC 1034 §3.1</a>),
                            which found no issued certificates.
                        </p>
                        <p class="mb-2">
                            To discover sibling subdomains (e.g., <code>mail.{{ ct.registered_domain }}</code>, <code>www.{{ ct.registered_domain }}</code>),
                            scan the registered domain instead:
                        </p>
                        <a href="{{ url_for('analyze') }}?domain={{ ct.registered_domain }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-search me-1"></i>Scan {{ ct.registered_domain }}
                        </a>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0 small">
                        <i class="fas fa-info-circle me-1"></i>
                        No subdomains found via Certificate Transparency logs, DNS probing, or CNAME chain traversal for this domain. No TLS certificates have been issued and no common service names resolve for subdomains of <strong>{{ domain }}</strong>.
                    </p>
                    {% endif %}
                    {% elif ct.get('status') == 'timeout' %}
                    <p class="text-muted mb-0 small">
                        <i class="fas fa-clock me-1"></i>
                        Certificate Transparency log query timed out. The CT log service (crt.sh) may be experiencing high load. Re-analyze the domain to try again.
                    </p>
                    {% elif ct.get('status') == 'not_available' %}
                    <p class="text-muted mb-0 small">
                        <i class="fas fa-info-circle me-1"></i>
                        Subdomain discovery data is not available for this older report. Re-analyze the domain to include CT log results.
                    </p>
                    {% else %}
                    <p class="text-muted mb-0 small">
                        <i class="fas fa-shield-alt me-1"></i>
                        Passive discovery using <strong>Certificate Transparency Logs</strong> — publicly auditable records of every TLS certificate ever issued.
                        {% if ct.get('message') %}{{ ct.message }}{% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        </div>

        <!-- Back to top -->
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Analyze Another Domain
            </a>
        </div>

        {% endif %}
        
        <!-- Test Send Recommendation -->
        {% if results.domain_exists != false %}
        <div class="card border-secondary mt-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-paper-plane fa-2x text-secondary opacity-75"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Confirm Your Email Configuration</h6>
                        <p class="text-muted mb-0 small">
                            This tool analyzes DNS records, but to verify actual email delivery, send a test email to 
                            <a href="https://redsift.com/tools/investigate" target="_blank" rel="noopener" class="text-info">
                                Red Sift Investigate<i class="fas fa-external-link-alt ms-1 small"></i></a>. 
                            Their tool shows exactly how your emails arrive, including SPF/DKIM/DMARC pass/fail results in the headers.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Data Freshness & Methodology Disclosure -->
        <div class="card border-secondary border-opacity-25 mt-4 mb-3">
            <div class="card-body py-3 px-4">
                <h6 class="text-muted mb-2" style="font-size: 0.8rem;"><i class="fas fa-flask me-1"></i>DATA FRESHNESS &amp; METHODOLOGY</h6>
                <p class="text-muted mb-2" style="font-size: 0.75rem; line-height: 1.6;">
                    All security-critical records (SPF, DMARC, DKIM, DANE/TLSA, DNSSEC, MTA-STS, TLS-RPT, BIMI, CAA) are queried <strong>live</strong> from authoritative nameservers and cross-referenced against 4 independent public DNS resolvers (Cloudflare, Google, Quad9, OpenDNS) at the time of each analysis. No security verdict uses cached data.
                </p>
                <p class="text-muted mb-2" style="font-size: 0.75rem; line-height: 1.6;">
                    <strong>Registrar data</strong> (RDAP) is cached for up to 6 hours because domain ownership and registration details change infrequently. <strong>Certificate Transparency logs</strong> (subdomain discovery via <a href="https://datatracker.ietf.org/doc/html/rfc6962" target="_blank" rel="noopener" class="text-info">RFC 6962</a>) are cached for 1 hour because CT entries are append-only historical records. Sections using cached data are marked with a <span class="badge bg-secondary bg-opacity-50 border border-secondary border-opacity-25" style="font-size: 0.55rem;">CACHED</span> badge; live queries show <span class="badge bg-success bg-opacity-25 border border-success border-opacity-25" style="font-size: 0.55rem;">LIVE</span>.
                </p>
                {% if results.get('ct_subdomains', {}).get('was_truncated') %}
                <p class="text-muted mb-0" style="font-size: 0.75rem; line-height: 1.6;">
                    <strong>Subdomain curation:</strong> From {{ results.ct_subdomains.unique_subdomains }} discovered subdomains, the {{ results.ct_subdomains.display_count }} shown were selected by security relevance: well-known service names (mail, vpn, api, sso, admin, etc.), DNS-resolving hosts, and subdomains with the most certificate activity are prioritized. CNAME chain resolution and provider identification run on the curated set for accuracy.
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-5 mb-4 text-muted small" role="contentinfo">
            <a href="https://www.it-help.tech" target="_blank" rel="noopener">
                <img src="{{ url_for('static', filename='images/owl-of-athena.png') }}" alt="IT Help San Diego - Owl of Athena" width="64" height="64" class="mb-2" loading="lazy" style="border-radius:50%;">
            </a>
            <p class="mb-1">Report reflects evaluated DNS security posture at time of generation.</p>
            <p class="mb-1">Made by <a href="https://www.it-help.tech/blog/dns-security-best-practices/" target="_blank" rel="noopener" class="text-info">IT Help San Diego Inc.</a></p>
            <p class="mb-0">Need help with DNS? Call <a href="tel:619-853-5008" class="text-info">619-853-5008</a></p>
        </footer>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-globe fa-spin"></i>
            </div>
            <h4 class="mt-4 mb-2">Analyzing Domain</h4>
            <p class="text-muted mb-0" id="loadingDomain">{{ domain }}</p>
            <div class="loading-dots mt-3">
                <span></span><span></span><span></span>
            </div>
            <div class="loading-status mt-3">
                <span>Initializing DNS resolver...</span>
                <span>Querying authoritative nameservers...</span>
                <span>Pulling A/AAAA records via DoH...</span>
                <span>Fetching MX records for mail routing...</span>
                <span>Running RDAP lookup for registrar info...</span>
                <span>Parsing SPF record from TXT...</span>
                <span>Validating DMARC policy...</span>
                <span>Checking DKIM selectors...</span>
                <span>Querying DNSSEC chain of trust...</span>
                <span>Aggregating multi-resolver consensus...</span>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v={{ app_version }}" defer></script>
    <script nonce="{{ csp_nonce }}">
    (function() {
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(el) {
                return new bootstrap.Tooltip(el);
            });
            
            // Re-analyze button handler
            var reanalyzeBtn = document.getElementById('reanalyzeBtn');
            if (reanalyzeBtn) {
                var waitSeconds = parseInt(reanalyzeBtn.getAttribute('data-wait-seconds')) || 0;
                var countdownInterval = null;
                
                function startCountdown(seconds) {
                    reanalyzeBtn.disabled = true;
                    reanalyzeBtn.classList.remove('btn-primary');
                    reanalyzeBtn.classList.add('btn-secondary');
                    
                    function updateButton() {
                        if (seconds <= 0) {
                            clearInterval(countdownInterval);
                            reanalyzeBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Re-analyze';
                            reanalyzeBtn.disabled = false;
                            reanalyzeBtn.classList.remove('btn-secondary');
                            reanalyzeBtn.classList.add('btn-primary');
                        } else {
                            reanalyzeBtn.innerHTML = '<i class="fas fa-clock me-2"></i>Ready in ' + seconds + 's';
                            seconds--;
                            countdownInterval = setTimeout(updateButton, 1000);
                        }
                    }
                    updateButton();
                }
                
                // Start countdown if wait_seconds is present
                if (waitSeconds > 0) {
                    startCountdown(waitSeconds);
                }
                
                reanalyzeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.disabled) return;
                    
                    var domain = this.getAttribute('data-domain');
                    var overlay = document.getElementById('loadingOverlay');
                    var btn = this;
                    
                    // Update button state immediately
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
                    btn.disabled = true;
                    
                    if (overlay) {
                        overlay.classList.remove('d-none');
                        if (typeof startStatusCycle === 'function') {
                            startStatusCycle(overlay);
                        }
                    }
                    
                    // Add cache-busting parameter to force fresh analysis
                    var timestamp = Date.now();
                    var url = '/analyze?domain=' + encodeURIComponent(domain) + '&refresh=' + timestamp;
                    
                    // Small delay to ensure overlay renders before navigation
                    setTimeout(function() {
                        window.location.href = url;
                    }, 100);
                });
            }
        });
    })();
    
    </script>
</body>
</html>
