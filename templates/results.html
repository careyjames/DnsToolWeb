<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#212529">
    <title>{{ domain }} - DNS Tool</title>
    <link rel="preconnect" href="https://cdn.replit.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    <style>
        @media print {
            /* Hide non-printable elements */
            .navbar, .btn, button, .no-print { display: none !important; }
            
            /* Preserve colors in print */
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            
            /* Avoid page breaks inside cards */
            .card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-globe me-2"></i>DNS Tool <span class="badge bg-info text-dark ms-1">v{{ app_version }}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('history') }}">
                            <i class="fas fa-history me-1"></i>History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('stats') }}">
                            <i class="fas fa-chart-bar me-1"></i>Statistics
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">DNS Intelligence Report</h1>
                <div class="text-muted">
                    <strong>{{ domain }}</strong>
                    {% if ascii_domain != domain %}
                        <span class="badge bg-secondary ms-2">ASCII: {{ ascii_domain }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" id="reanalyzeBtn" class="btn btn-primary" data-domain="{{ domain }}">
                    <i class="fas fa-sync-alt me-2"></i>Re-analyze
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-search me-2"></i>New Domain
                </a>
            </div>
        </div>
        
        <!-- Non-existent Domain Banner -->
        {% if results.domain_exists == false %}
        <div class="card border-info mb-4">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-question-circle fa-4x text-info opacity-75"></i>
                </div>
                <h2 class="h3 mb-3">
                    <span class="badge bg-info-subtle text-info border border-info px-4 py-2">
                        <i class="fas fa-globe-americas me-2"></i>Non-existent / Undelegated Domain
                    </span>
                </h2>
                <p class="lead text-muted mb-4">{{ results.domain_status_message or 'This domain does not exist in DNS.' }}</p>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="alert alert-info bg-info-subtle border-info mb-0">
                            <h6 class="alert-heading mb-2"><i class="fas fa-info-circle me-2"></i>What This Means</h6>
                            <ul class="text-start mb-0 small">
                                <li>No authoritative DNS data is available for this domain</li>
                                <li>Security posture cannot be evaluated without DNS records</li>
                                <li>The domain may never have been registered, or has expired</li>
                                <li>If this is your domain, check your registrar to ensure it's active</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-search me-2"></i>Try Another Domain
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        
        <!-- Global Posture Score -->
        {% if results.posture %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-{{ results.posture.color }} bg-{{ results.posture.color }} bg-opacity-10">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-{{ results.posture.icon }} fa-2x text-{{ results.posture.color }} me-3"></i>
                                <div>
                                    <div class="d-flex align-items-center">
                                        <span class="text-muted small me-2">DNS & Trust Posture:</span>
                                        <span class="badge bg-{{ results.posture.color }} fs-6 px-3 py-2">{{ results.posture.state }}</span>
                                    </div>
                                    <small class="text-muted">{{ results.posture.message }}</small>
                                </div>
                            </div>
                            {% if results.posture.issues or results.posture.monitoring %}
                            <div class="mt-2 mt-md-0">
                                {% if results.posture.issues %}
                                    <small class="text-danger d-block"><i class="fas fa-times-circle me-1"></i>{{ results.posture.issues|length }} issue{{ 's' if results.posture.issues|length > 1 else '' }}</small>
                                {% endif %}
                                {% if results.posture.monitoring %}
                                    <small class="text-info d-block"><i class="fas fa-eye me-1"></i>{{ results.posture.monitoring|length }} monitoring</small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Findings Summary Block - Clean 2-Column Layout -->
        {% if results.posture and (results.posture.issues or results.posture.monitoring or results.posture.configured or results.posture.absent) %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card border-0 bg-dark bg-opacity-50">
                    <div class="card-body py-2 px-3">
                        <div class="row g-2 align-items-start small">
                            {% if results.posture.issues %}
                            <div class="col-6 col-lg-3">
                                <span class="text-danger fw-bold"><i class="fas fa-times-circle me-1"></i>Action Required</span>
                                <div class="text-danger-emphasis">{% for issue in results.posture.issues %}{{ issue }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                            {% if results.posture.monitoring %}
                            <div class="col-6 col-lg-3">
                                <span class="text-warning fw-bold"><i class="fas fa-eye me-1"></i>Monitoring</span>
                                <div class="text-warning-emphasis">{% for item in results.posture.monitoring %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                            {% if results.posture.configured %}
                            <div class="col-6 col-lg-3">
                                <span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Configured</span>
                                <div class="text-success-emphasis">{% for item in results.posture.configured %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                            {% if results.posture.absent %}
                            <div class="col-6 col-lg-3">
                                <span class="text-muted fw-bold"><i class="fas fa-minus-circle me-1"></i>Not Configured</span>
                                <div class="text-muted">{% for item in results.posture.absent %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- Domain Summary Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary border-opacity-25 bg-primary bg-opacity-10">
                    <div class="card-body py-3">
                        <div class="row align-items-center">
                            <div class="col-md-3 border-end border-primary border-opacity-10">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Registrar <span class="text-info">({{ results.registrar_info.source|upper if results.registrar_info.source else '?' }})</span></small>
                                <div class="text-truncate" title="{{ results.registrar_info.registrar or 'Unknown' }}">
                                    <i class="fas fa-id-card text-primary me-2"></i>
                                    <strong>{{ results.registrar_info.registrar.split('(')[0].strip() if results.registrar_info.registrar else 'Unknown' }}</strong>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">Where you pay to own domain</small>
                            </div>
                            <div class="col-md-3 border-end border-primary border-opacity-10">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Email Service Provider</small>
                                <div class="text-truncate">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    <strong>{{ results.hosting_summary.email_hosting if results.hosting_summary and results.hosting_summary.email_hosting else 'Unknown' }}</strong>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">Where email is hosted (MX)</small>
                            </div>
                            <div class="col-md-3 border-end border-primary border-opacity-10">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Web Hosting</small>
                                <div class="text-truncate">
                                    <i class="fas fa-server text-primary me-2"></i>
                                    <strong>{{ results.hosting_summary.hosting if results.hosting_summary else 'Unknown' }}</strong>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">Where website is hosted</small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">DNS Hosting</small>
                                <div class="text-truncate">
                                    <i class="fas fa-network-wired text-primary me-2"></i>
                                    <strong>{{ results.hosting_summary.dns_hosting if results.hosting_summary else 'Standard' }}</strong>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.65rem;">Where DNS records are edited</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-email-security">
            <!-- Email Security Section -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                            <span><i class="fas fa-shield-alt me-2"></i>Email Security</span>
                            <small class="text-muted">Can this domain be impersonated by email?
                                {% if results.posture and results.posture.verdicts.email_answer %}
                                    <span class="badge bg-{{ 'success' if results.posture.verdicts.email_answer == 'No' else 'warning' if 'Mostly' in results.posture.verdicts.email_answer or 'Partially' in results.posture.verdicts.email_answer else 'danger' }} ms-1">{{ results.posture.verdicts.email_answer }}</span>
                                {% endif %}
                            </small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if results.posture and results.posture.verdicts.email %}
                            <div class="alert alert-{{ 'success' if results.posture.verdicts.email_answer == 'No' else 'warning' if 'Mostly' in results.posture.verdicts.email_answer or 'Partially' in results.posture.verdicts.email_answer else 'danger' }} py-2 mb-3 small">
                                <i class="fas fa-gavel me-2"></i><strong>Verdict:</strong> {{ results.posture.verdicts.email }}
                            </div>
                        {% endif %}
                        <div class="row">
                            <!-- SPF Analysis -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center mb-1">
                                    <i class="fas fa-envelope me-2"></i>SPF Record
                                    <a href="https://datatracker.ietf.org/doc/html/rfc7208" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Sender Policy Framework</strong><br>Specifies which mail servers can send email for your domain." aria-label="Learn about SPF - RFC 7208"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 7208</span></a>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if results.spf_analysis.status == 'success' else 'danger' if results.spf_analysis.status == 'error' else 'warning' }}">
                                        {{ results.spf_analysis.status|title }}
                                    </span>
                                    {% if results.spf_analysis.permissiveness %}
                                        <span class="badge bg-{{ 'danger' if results.spf_analysis.permissiveness == 'DANGEROUS' else 'success' if results.spf_analysis.permissiveness == 'STRICT' else 'warning' }} ms-1">{{ results.spf_analysis.all_mechanism or '' }}</span>
                                    {% endif %}
                                    {% if results.spf_analysis.lookup_count is defined %}
                                        <span class="badge bg-{{ 'danger' if results.spf_analysis.lookup_count > 10 else 'warning' if results.spf_analysis.lookup_count >= 8 else 'secondary' }} ms-1" data-bs-toggle="tooltip" title="DNS lookup limit is 10">{{ results.spf_analysis.lookup_count }}/10 lookups</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2 small">{{ results.spf_analysis.message }}</p>
                                {% if results.spf_analysis.valid_records %}
                                    {% for record in results.spf_analysis.valid_records %}
                                        <div class="code-block small">{{ record }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if results.spf_analysis.issues %}
                                    <div class="mt-2 small">
                                        {% for issue in results.spf_analysis.issues %}
                                            <div class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.spf_analysis.spf_like %}
                                    <div class="mt-2 p-2 bg-danger bg-opacity-10 border border-danger rounded">
                                        <small class="text-danger d-block fw-bold">
                                            <i class="fas fa-exclamation-circle me-1"></i>
                                            Duplicate SPF records found!
                                        </small>
                                        <small class="text-muted d-block">Only one SPF record is allowed per domain. Multiple records can cause delivery issues.</small>
                                        {% for record in results.spf_analysis.spf_like %}
                                            <div class="code-block small mt-1 border-danger text-danger">{{ record }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- DMARC Analysis -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center mb-1">
                                    <i class="fas fa-lock me-2"></i>DMARC Policy
                                    <a href="https://datatracker.ietf.org/doc/html/rfc7489" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Domain-based Message Authentication</strong><br>Tells receivers how to handle SPF/DKIM failures and where to send reports." aria-label="Learn about DMARC - RFC 7489"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 7489</span></a>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if results.dmarc_analysis.status == 'success' else 'danger' if results.dmarc_analysis.status == 'error' else 'warning' }}">
                                        {% if results.dmarc_analysis.no_mail_recommendation %}
                                            Recommended
                                        {% else %}
                                            {{ results.dmarc_analysis.status|title }}
                                        {% endif %}
                                    </span>
                                    {% if results.dmarc_analysis.policy %}
                                        <span class="badge bg-{{ 'success' if results.dmarc_analysis.policy == 'reject' else 'warning' if results.dmarc_analysis.policy == 'quarantine' else 'secondary' }} ms-1">p={{ results.dmarc_analysis.policy }}</span>
                                    {% endif %}
                                    {% if results.dmarc_analysis.pct is defined and results.dmarc_analysis.pct < 100 %}
                                        <span class="badge bg-warning ms-1">{{ results.dmarc_analysis.pct }}% enforced</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2 small">{{ results.dmarc_analysis.message }}</p>
                                {% if results.dmarc_analysis.no_mail_recommendation and results.dmarc_analysis.suggested_record %}
                                    <div class="alert alert-info py-2 px-3 mb-2">
                                        <small><i class="fas fa-lightbulb me-1"></i>Add this TXT record at <code>_dmarc.{{ domain }}</code>:</small>
                                        <div class="code-block small mt-1 bg-dark text-success border-success">{{ results.dmarc_analysis.suggested_record }}</div>
                                    </div>
                                {% endif %}
                                {% if results.dmarc_analysis.valid_records %}
                                    {% for record in results.dmarc_analysis.valid_records %}
                                        <div class="code-block small">{{ record }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if results.dmarc_analysis.policy and results.dmarc_analysis.status == 'success' %}
                                    <div class="mt-2 small">
                                        <span class="text-muted">Alignment:</span>
                                        <span class="badge bg-secondary">SPF {{ results.dmarc_analysis.aspf or 'relaxed' }}</span>
                                        <span class="badge bg-secondary">DKIM {{ results.dmarc_analysis.adkim or 'relaxed' }}</span>
                                        {% if results.dmarc_analysis.subdomain_policy %}
                                            <span class="badge bg-{{ 'success' if results.dmarc_analysis.subdomain_policy == 'reject' else 'warning' if results.dmarc_analysis.subdomain_policy == 'quarantine' else 'secondary' }}">sp={{ results.dmarc_analysis.subdomain_policy }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% if results.dmarc_analysis.issues %}
                                    <div class="mt-2 small">
                                        {% for issue in results.dmarc_analysis.issues %}
                                            <div class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- DKIM Analysis -->
                            <div class="col-md-4">
                                <h6 class="d-flex align-items-center mb-1">
                                    <i class="fas fa-key me-2"></i>DKIM Records
                                    <a href="https://datatracker.ietf.org/doc/html/rfc6376" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>DomainKeys Identified Mail</strong><br>Cryptographic signatures that verify email hasn't been altered in transit." aria-label="Learn about DKIM - RFC 6376"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 6376</span></a>
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if results.dkim_analysis.status == 'success' else 'warning' if results.dkim_analysis.status == 'warning' else 'secondary' }}">
                                        {{ 'Found' if results.dkim_analysis.status == 'success' else 'Weak Keys' if results.dkim_analysis.status == 'warning' else 'Not Discoverable' }}
                                    </span>
                                    {% if results.dkim_analysis.key_strengths %}
                                        <span class="badge bg-success ms-1">{{ results.dkim_analysis.key_strengths|join(', ') }}</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2 small">{{ results.dkim_analysis.message }}</p>
                                {% if results.dkim_analysis.key_issues %}
                                    <div class="mb-2 small">
                                        {% for issue in results.dkim_analysis.key_issues %}
                                            <div class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ issue }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.dkim_analysis.selectors %}
                                    {% for selector, selector_data in results.dkim_analysis.selectors.items() %}
                                        <div class="mb-2">
                                            <small class="text-success d-block">
                                                <i class="fas fa-check-circle me-1"></i>{{ selector }}
                                                {% if selector_data.key_info %}
                                                    {% for ki in selector_data.key_info %}
                                                        {% if ki.key_bits %}
                                                            <span class="badge bg-{{ 'warning' if ki.key_bits < 2048 else 'success' }} ms-1">{{ ki.key_bits }}-bit</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </small>
                                            {% if selector_data.records %}
                                                {% for record in selector_data.records %}
                                                    <div class="code-block small mt-1" style="word-break: break-all;">{{ record }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Second Row: MTA-STS and TLS-RPT -->
                        <div class="row mt-4 pt-3 border-top mta-sts-tlsrpt-row">
                            <!-- MTA-STS Analysis -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-shield-alt me-2"></i>MTA-STS
                                    <a href="https://datatracker.ietf.org/doc/html/rfc8461" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>SMTP MTA Strict Transport Security</strong><br>Forces TLS encryption between mail servers to prevent downgrade attacks." aria-label="Learn about MTA-STS - RFC 8461"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 8461</span></a>
                                    <span class="badge bg-{{ 'success' if results.mta_sts_analysis.status == 'success' else 'warning' }} ms-2">
                                        {{ results.mta_sts_analysis.status|title }}
                                    </span>
                                    {% if results.mta_sts_analysis.mode %}
                                        <span class="badge bg-{{ 'success' if results.mta_sts_analysis.mode == 'enforce' else 'warning' }} ms-1">{{ results.mta_sts_analysis.mode|upper }}</span>
                                    {% endif %}
                                    {% if results.mta_sts_analysis.policy_fetched %}
                                        <span class="badge bg-info ms-1" title="Policy file fetched and validated"><i class="fas fa-check-circle"></i> Policy Verified</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.mta_sts_analysis.message }}</p>
                                {% if results.mta_sts_analysis.record %}
                                    <div class="code-block small">{{ results.mta_sts_analysis.record }}</div>
                                {% endif %}
                                {% if results.mta_sts_analysis.policy_fetched %}
                                    <div class="mt-2 small">
                                        <strong>Policy Details:</strong>
                                        <ul class="mb-0 ps-3">
                                            {% if results.mta_sts_analysis.policy_mode %}
                                                <li>Mode: <code>{{ results.mta_sts_analysis.policy_mode }}</code></li>
                                            {% endif %}
                                            {% if results.mta_sts_analysis.policy_max_age %}
                                                <li>Max Age: {{ results.mta_sts_analysis.policy_max_age // 86400 }} days ({{ results.mta_sts_analysis.policy_max_age }} seconds)</li>
                                            {% endif %}
                                            {% if results.mta_sts_analysis.policy_mx %}
                                                <li>MX Patterns: {{ results.mta_sts_analysis.policy_mx|join(', ') }}</li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                {% elif results.mta_sts_analysis.policy_error %}
                                    <div class="mt-2 small text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Policy file: {{ results.mta_sts_analysis.policy_error }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- TLS-RPT Analysis -->
                            <div class="col-md-6">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-file-alt me-2"></i>TLS-RPT
                                    <a href="https://datatracker.ietf.org/doc/html/rfc8460" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>TLS Reporting</strong><br>Sends reports about TLS connection failures to help diagnose delivery issues." aria-label="Learn about TLS-RPT - RFC 8460"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 8460</span></a>
                                    <span class="badge bg-{{ 'success' if results.tlsrpt_analysis.status == 'success' else 'warning' }} ms-2">
                                        {{ results.tlsrpt_analysis.status|title }}
                                    </span>
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.tlsrpt_analysis.message }}</p>
                                {% if results.tlsrpt_analysis.record %}
                                    <div class="code-block small">{{ results.tlsrpt_analysis.record }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Brand Security Section -->
        <div class="row section-brand-security">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                            <span><i class="fas fa-certificate me-2"></i>Brand Security</span>
                            <small class="text-muted">Can this brand be convincingly faked?
                                {% if results.posture and results.posture.verdicts.brand_secure %}
                                    <span class="badge bg-success ms-1">No</span>
                                {% elif results.posture and results.posture.verdicts.brand %}
                                    <span class="badge bg-warning ms-1">Partially</span>
                                {% endif %}
                            </small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if results.posture and results.posture.verdicts.brand %}
                            <div class="alert alert-{{ 'success' if results.posture.verdicts.brand_secure else 'warning' }} py-2 mb-3 small">
                                <i class="fas fa-gavel me-2"></i><strong>Verdict:</strong> {{ results.posture.verdicts.brand }}
                            </div>
                        {% endif %}
                        <div class="row">
                            <!-- BIMI Analysis -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-image me-2"></i>BIMI
                                    <a href="https://bimigroup.org/implementation-guide/" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Brand Indicators for Message Identification</strong><br>Displays your brand logo next to emails in recipients' inboxes." aria-label="Learn about BIMI - BIMI Group Specification"><i class="fas fa-info-circle"></i><span class="rfc-label">BIMI Spec</span></a>
                                    <span class="badge bg-{{ 'success' if results.bimi_analysis.status == 'success' else 'warning' }} ms-2">
                                        {{ results.bimi_analysis.status|title }}
                                    </span>
                                    {% if results.bimi_analysis.vmc_url %}
                                        {% if results.bimi_analysis.vmc_valid %}
                                            <span class="badge bg-success ms-1"><i class="fas fa-certificate me-1"></i>VMC</span>
                                        {% else %}
                                            <span class="badge bg-warning ms-1">VMC</span>
                                        {% endif %}
                                    {% elif results.bimi_analysis.logo_url %}
                                        <span class="badge bg-info ms-1">No VMC</span>
                                    {% endif %}
                                    {% if results.bimi_analysis.logo_valid %}
                                        <span class="badge bg-success ms-1" title="Logo validated"><i class="fas fa-check"></i> {{ results.bimi_analysis.logo_format or 'Logo' }}</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.bimi_analysis.message }}</p>
                                {% if results.bimi_analysis.status == 'success' and not results.bimi_analysis.vmc_url %}
                                    <div class="small text-info mb-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        BIMI works without VMC! VMC (Verified Mark Certificate) requires a registered trademark. Small businesses can use BIMI with just a logo - it shows in Apple Mail and some providers. Gmail requires VMC.
                                    </div>
                                {% elif results.bimi_analysis.vmc_valid %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        VMC certificate accessible{% if results.bimi_analysis.vmc_issuer %} (from {{ results.bimi_analysis.vmc_issuer }}){% endif %} - logo displays in Gmail, Apple Mail, and all major providers.
                                    </div>
                                {% elif results.bimi_analysis.vmc_url %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        VMC certificate found{% if results.bimi_analysis.vmc_error %} - {{ results.bimi_analysis.vmc_error }}{% endif %}
                                    </div>
                                {% endif %}
                                {% if results.bimi_analysis.record %}
                                    <div class="code-block small">{{ results.bimi_analysis.record }}</div>
                                {% endif %}
                                {% if results.bimi_analysis.logo_url %}
                                    <div class="mt-3 d-flex align-items-center">
                                        <div class="me-3 p-2 bg-white rounded" style="flex-shrink: 0; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                                            <img src="{{ url_for('proxy_bimi_logo', url=results.bimi_analysis.logo_url) }}" 
                                                 alt="BIMI Logo" 
                                                 style="width: 48px; height: 48px; object-fit: contain;"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                            <i class="fas fa-image fa-2x text-muted" style="display: none;"></i>
                                        </div>
                                        <div class="small">
                                            {% if results.bimi_analysis.logo_valid %}
                                                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Logo validated ({{ results.bimi_analysis.logo_format or 'SVG' }})</span>
                                            {% elif results.bimi_analysis.logo_error %}
                                                <span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ results.bimi_analysis.logo_error }}</span>
                                            {% else %}
                                                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Logo found</span>
                                            {% endif %}
                                            <a href="{{ results.bimi_analysis.logo_url }}" target="_blank" class="d-block text-info text-truncate" style="max-width: 200px;" title="{{ results.bimi_analysis.logo_url }}">
                                                <i class="fas fa-external-link-alt me-1"></i>View full logo
                                            </a>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- CAA Analysis -->
                            <div class="col-md-6">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-lock me-2"></i>CAA
                                    <a href="https://datatracker.ietf.org/doc/html/rfc8659" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>Certificate Authority Authorization</strong><br>Controls which CAs can issue SSL certificates for your domain." aria-label="Learn about CAA - RFC 8659"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 8659</span></a>
                                    <span class="badge bg-{{ 'success' if results.caa_analysis.status == 'success' else 'warning' }} ms-2">
                                        {{ results.caa_analysis.status|title }}
                                    </span>
                                    {% if results.caa_analysis.has_iodef %}
                                        <span class="badge bg-info ms-1">IODEF</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.caa_analysis.message }}</p>
                                {% if results.caa_analysis.issuers %}
                                    <div class="mb-2">
                                        <small class="text-muted">Authorized CAs:</small>
                                        {% for issuer in results.caa_analysis.issuers %}
                                            <span class="badge bg-primary ms-1">{{ issuer }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if results.caa_analysis.records %}
                                    {% for record in results.caa_analysis.records %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Domain Security Section (DNSSEC + NS Delegation) -->
        <div class="row section-domain-security">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                            <span><i class="fas fa-shield-alt me-2"></i>Domain Security</span>
                            <small class="text-muted">Can DNS itself be tampered with?
                                {% if results.posture and results.posture.verdicts.domain_answer %}
                                    <span class="badge bg-{{ 'success' if results.posture.verdicts.domain_answer == 'No' else 'warning' }} ms-1">{{ results.posture.verdicts.domain_answer }}</span>
                                {% endif %}
                            </small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if results.posture and results.posture.verdicts.domain %}
                            <div class="alert alert-{{ 'success' if 'authenticated' in results.posture.verdicts.domain else 'warning' }} py-2 mb-3 small">
                                <i class="fas fa-gavel me-2"></i><strong>Verdict:</strong> {{ results.posture.verdicts.domain }}
                            </div>
                        {% endif %}
                        <div class="row">
                            <!-- DNSSEC Analysis -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-key me-2"></i>DNSSEC
                                    <a href="https://datatracker.ietf.org/doc/html/rfc4033" target="_blank" rel="noopener" class="ms-2 text-muted rfc-link" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>DNS Security Extensions</strong><br>Cryptographic signatures that prove DNS responses are authentic and untampered." aria-label="Learn about DNSSEC - RFC 4033-4035"><i class="fas fa-info-circle"></i><span class="rfc-label">RFC 4033</span></a>
                                    <span class="badge bg-{{ 'success' if results.dnssec_analysis.status == 'success' else 'warning' }} ms-2">
                                        {{ 'Signed' if results.dnssec_analysis.status == 'success' else 'Unsigned' }}
                                    </span>
                                    {% if results.dnssec_analysis.algorithm_name %}
                                        <span class="badge bg-info ms-1">{{ results.dnssec_analysis.algorithm_name }}</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.dnssec_analysis.message }}</p>
                                
                                {% if results.dnssec_analysis.status == 'success' %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Chain of trust: Root → TLD → Domain. DNS responses are authenticated and tamper-proof.
                                    </div>
                                    {% if results.dnssec_analysis.ad_flag %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>AD Flag:</strong> <span class="badge bg-success">Validated</span>
                                        <span class="text-muted">- Resolver ({{ results.dnssec_analysis.ad_resolver }}) confirmed cryptographic signatures</span>
                                    </div>
                                    {% else %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>AD Flag:</strong> <span class="badge bg-warning text-dark">Not Set</span>
                                        <span class="text-muted">- Records exist but resolver didn't confirm validation</span>
                                    </div>
                                    {% endif %}
                                {% elif results.dnssec_analysis.chain_of_trust == 'broken' %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        DNSKEY exists but DS record not published at registrar. Add DS record to complete chain of trust.
                                    </div>
                                {% else %}
                                    <div class="small text-muted mb-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Domain does not use DNSSEC. Large organizations often secure at other layers; for smaller domains, consider enabling at your registrar.
                                    </div>
                                {% endif %}
                                
                                {% if results.dnssec_analysis.ds_records %}
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">DS Record (at registrar):</small>
                                        {% for ds in results.dnssec_analysis.ds_records %}
                                            <div class="code-block small mb-1" style="font-size: 0.7rem;">{{ ds }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- NS Delegation Analysis -->
                            <div class="col-md-6">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-project-diagram me-2"></i>NS Delegation
                                    <span class="badge bg-{{ 'success' if results.ns_delegation_analysis.status == 'success' else 'warning' if results.ns_delegation_analysis.status == 'warning' else 'secondary' }} ms-2">
                                        {{ 'Verified' if results.ns_delegation_analysis.delegation_ok else 'Check Failed' }}
                                    </span>
                                    {% if results.ns_delegation_analysis.match == true %}
                                        <span class="badge bg-success ms-1">Match</span>
                                    {% elif results.ns_delegation_analysis.match == false %}
                                        <span class="badge bg-warning ms-1">Mismatch</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2 small">{{ results.ns_delegation_analysis.message }}</p>
                                
                                {% if results.ns_delegation_analysis.match == false %}
                                    <div class="small text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        NS records at domain differ from parent zone delegation. May indicate recent DNS migration still propagating.
                                    </div>
                                {% elif results.ns_delegation_analysis.match == true %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Parent zone delegation matches domain's NS records. No delegation drift detected.
                                    </div>
                                {% endif %}
                                
                                {% if results.ns_delegation_analysis.child_ns %}
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">Nameservers:</small>
                                        {% for ns in results.ns_delegation_analysis.child_ns %}
                                            <span class="badge bg-secondary me-1 mb-1">{{ ns }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic & Routing Section -->
        <div class="row section-traffic-routing">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-route me-2"></i>Traffic & Routing
                            <small class="text-muted ms-2">Where traffic flows &amp; how services resolve</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- A Records (IPv4) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-primary me-2">A</span>IPv4 Address
                                </h6>
                                {% if results.basic_records.A %}
                                    {% for record in results.basic_records.A %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    <small class="text-muted">Where the domain points for web traffic</small>
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No A records</div>
                                    <small class="text-info">Domain may use AAAA (IPv6) only or CNAME</small>
                                {% endif %}
                            </div>

                            <!-- AAAA Records (IPv6) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-info me-2">AAAA</span>IPv6 Address
                                </h6>
                                {% if results.basic_records.AAAA %}
                                    {% for record in results.basic_records.AAAA %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    <small class="text-success"><i class="fas fa-check me-1"></i>IPv6 ready</small>
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No AAAA records</div>
                                    <small class="text-muted">IPv6 not configured</small>
                                {% endif %}
                            </div>

                            <!-- MX Records (Mail) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-warning text-dark me-2">MX</span>Mail Servers
                                </h6>
                                {% if results.basic_records.MX %}
                                    {% set mx_list = results.basic_records.MX|join(' ')|lower %}
                                    {% set is_google = 'google' in mx_list or 'googlemail' in mx_list %}
                                    {% set mx_count = results.basic_records.MX|length %}
                                    {% for record in results.basic_records.MX %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    {% if is_google and mx_count > 1 %}
                                        <div class="text-warning small mt-1">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Legacy setup:</strong> Google Workspace now only needs 1 MX record (smtp.google.com). You can simplify by removing the extra {{ mx_count - 1 }} record{{ 's' if mx_count > 2 else '' }}.
                                        </div>
                                    {% else %}
                                        <small class="text-muted">Priority + mail server for email delivery</small>
                                    {% endif %}
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No MX records</div>
                                    <small class="text-warning">Domain cannot receive email</small>
                                {% endif %}
                            </div>

                            <!-- SRV Records (Services) -->
                            <div class="col-md-3 mb-3">
                                <h6 class="d-flex align-items-center">
                                    <span class="badge bg-secondary me-2">SRV</span>Services
                                </h6>
                                {% if results.basic_records.SRV %}
                                    {% for record in results.basic_records.SRV %}
                                        <div class="code-block small mb-1">{{ record }}</div>
                                    {% endfor %}
                                    <small class="text-muted">SIP, XMPP, or other service endpoints</small>
                                {% else %}
                                    <div class="text-muted small"><i class="fas fa-minus me-1"></i>No SRV records</div>
                                    <small class="text-muted">No service-specific routing configured</small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Summary bar -->
                        <div class="border-top pt-3 mt-2">
                            <div class="d-flex flex-wrap gap-3 small">
                                <span>
                                    <i class="fas fa-globe me-1 text-primary"></i>
                                    <strong>Web:</strong>
                                    {% if results.basic_records.A or results.basic_records.AAAA %}
                                        <span class="text-success">Reachable</span>
                                        ({{ results.basic_records.A|length if results.basic_records.A else 0 }} IPv4, {{ results.basic_records.AAAA|length if results.basic_records.AAAA else 0 }} IPv6)
                                    {% else %}
                                        <span class="text-warning">No direct IP</span>
                                    {% endif %}
                                </span>
                                <span>
                                    <i class="fas fa-envelope me-1 text-warning"></i>
                                    <strong>Mail:</strong>
                                    {% if results.basic_records.MX %}
                                        <span class="text-success">{{ results.basic_records.MX|length }} server{{ 's' if results.basic_records.MX|length > 1 else '' }}</span>
                                    {% else %}
                                        <span class="text-danger">Not configured</span>
                                    {% endif %}
                                </span>
                                <span>
                                    <i class="fas fa-cogs me-1 text-secondary"></i>
                                    <strong>Services:</strong>
                                    {% if results.basic_records.SRV %}
                                        <span class="text-success">{{ results.basic_records.SRV|length }} endpoint{{ 's' if results.basic_records.SRV|length > 1 else '' }}</span>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Propagation Delta Summary -->
        {% set propagating_types = [] %}
        {% set synced_count = 0 %}
        {% if results.propagation_status %}
            {% for rtype, pinfo in results.propagation_status.items() %}
                {% if pinfo.status == 'propagating' %}
                    {% set _ = propagating_types.append(rtype) %}
                {% elif pinfo.status == 'synchronized' %}
                    {% set synced_count = synced_count + 1 %}
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <div class="row mb-3">
            <div class="col-12">
                {% if propagating_types %}
                <div class="alert alert-warning py-2 mb-0 d-flex align-items-center justify-content-between flex-wrap">
                    <div>
                        <i class="fas fa-sync-alt fa-spin me-2"></i>
                        <strong>Δ Changes Detected:</strong>
                        {% for rtype in propagating_types %}
                            <span class="badge bg-warning text-dark ms-1">{{ rtype }}</span>
                        {% endfor %}
                        <span class="ms-2 small text-muted">Resolver ≠ Authoritative (TTL / CDN rotation / recent change)</span>
                    </div>
                    <small class="text-warning-emphasis">
                        <i class="fas fa-clock me-1"></i>Risk: Low - typically resolves within TTL
                    </small>
                </div>
                {% else %}
                <div class="alert alert-success py-2 mb-0 d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Δ No Propagation Issues:</strong>
                    <span class="ms-2 small">All DNS records are synchronized between resolver and authoritative nameserver.</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Live DNS Diff Feature Callout -->
        <div class="card bg-dark border-info mb-4">
            <div class="card-body py-3">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="badge bg-info text-dark px-3 py-2" style="font-size: 0.9rem;">
                            <i class="fas fa-code-compare me-2"></i>Live DNS Diff
                        </span>
                    </div>
                    <div>
                        <strong class="text-info">Real-time propagation comparison</strong>
                        <span class="text-muted ms-2">|</span>
                        <span class="text-light ms-2">See exactly what public resolvers return vs. what your authoritative nameserver has. Spot propagation delays, stale cache, and DNS misconfigurations instantly.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- DNS Diff Section - True Side-by-Side Comparison -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-code-compare me-2"></i>DNS Evidence Diff
                        <small class="text-muted ms-2">Side-by-side comparison</small>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- Diff Header Row -->
                    <div class="dns-diff-container">
                        <div class="dns-diff-header">
                            <div class="dns-diff-col dns-diff-left">
                                <i class="fas fa-database me-2"></i>Resolver Records
                                <small class="opacity-75">(Public DNS cache)</small>
                            </div>
                            <div class="dns-diff-col dns-diff-right">
                                <i class="fas fa-microchip me-2"></i>Authoritative Records
                                <small class="opacity-75">(Source of truth)</small>
                            </div>
                        </div>
                        
                        {% for record_type in results.basic_records.keys() %}
                            {% set resolver_records = results.basic_records.get(record_type, []) %}
                            {% set auth_records = results.authoritative_records.get(record_type, []) if results.authoritative_records else [] %}
                            {% set max_len = [resolver_records|length, auth_records|length]|max %}
                            
                            {% if max_len > 0 or record_type in ['A', 'AAAA', 'MX', 'NS', 'TXT'] %}
                                <!-- Record Type Header -->
                                <div class="dns-diff-type-header">
                                    <span class="badge bg-secondary me-2">{{ record_type }}</span>
                                    {% if results.propagation_status and record_type in results.propagation_status %}
                                        {% set p_info = results.propagation_status[record_type] %}
                                        {% if p_info.status == 'synchronized' %}
                                            <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-check-double me-1"></i>Synchronized
                                            </span>
                                        {% elif p_info.status == 'propagating' %}
                                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-clock me-1"></i>Propagating
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <span class="ms-auto text-muted small">
                                        {{ resolver_records|length }} / {{ auth_records|length }} records
                                    </span>
                                </div>
                                
                                <!-- Record Rows -->
                                {% if max_len > 0 %}
                                    {% for i in range(max_len) %}
                                        {% set resolver_val = resolver_records[i] if i < resolver_records|length else none %}
                                        {% set auth_val = auth_records[i] if i < auth_records|length else none %}
                                        {% set is_match = resolver_val == auth_val %}
                                        
                                        <div class="dns-diff-row {% if not is_match and resolver_val and auth_val %}dns-diff-changed{% elif not resolver_val %}dns-diff-added{% elif not auth_val %}dns-diff-removed{% endif %}">
                                            <div class="dns-diff-col dns-diff-left {% if not resolver_val %}dns-diff-empty{% elif not is_match %}dns-diff-highlight-old{% endif %}">
                                                {% if resolver_val %}
                                                    <code class="dns-diff-value">{{ resolver_val }}</code>
                                                {% else %}
                                                    <span class="dns-diff-placeholder">—</span>
                                                {% endif %}
                                            </div>
                                            <div class="dns-diff-col dns-diff-right {% if not auth_val %}dns-diff-empty{% elif not is_match %}dns-diff-highlight-new{% endif %}">
                                                {% if auth_val %}
                                                    <code class="dns-diff-value">{{ auth_val }}</code>
                                                {% else %}
                                                    <span class="dns-diff-placeholder">—</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="dns-diff-row">
                                        <div class="dns-diff-col dns-diff-left dns-diff-empty">
                                            <span class="dns-diff-placeholder">No records</span>
                                        </div>
                                        <div class="dns-diff-col dns-diff-right dns-diff-empty">
                                            <span class="dns-diff-placeholder">No records</span>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if not results.authoritative_records or results.authoritative_records.values()|map('length')|sum == 0 %}
                            <div class="dns-diff-notice">
                                <i class="fas fa-info-circle me-2"></i>
                                Authoritative records unavailable - nameserver may be blocking direct queries
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Back to top -->
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Analyze Another Domain
            </a>
        </div>

        {% endif %}
        
        <!-- Test Send Recommendation -->
        {% if results.domain_exists != false %}
        <div class="card border-secondary mt-4 no-print">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-paper-plane fa-2x text-secondary opacity-75"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Confirm Your Email Configuration</h6>
                        <p class="text-muted mb-0 small">
                            This tool analyzes DNS records, but to verify actual email delivery, send a test email to 
                            <a href="https://redsift.com/tools/investigate" target="_blank" rel="noopener" class="text-info">
                                Red Sift Investigate<i class="fas fa-external-link-alt ms-1 small"></i></a>. 
                            Their tool shows exactly how your emails arrive, including SPF/DKIM/DMARC pass/fail results in the headers.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Footer -->
        <footer class="text-center mt-5 mb-4 text-muted small">
            <p class="mb-1">Report reflects evaluated DNS security posture at time of generation.</p>
            <p class="mb-1">Made by <a href="https://www.it-help.tech/blog/dns-security-best-practices/" target="_blank" rel="noopener" class="text-info">IT Help San Diego Inc.</a></p>
            <p class="mb-0">Need help with DNS? Call <a href="tel:619-853-5008" class="text-info">619-853-5008</a></p>
        </footer>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-globe fa-spin"></i>
            </div>
            <h4 class="mt-4 mb-2">Analyzing Domain</h4>
            <p class="text-muted mb-0" id="loadingDomain">{{ domain }}</p>
            <div class="loading-dots mt-3">
                <span></span><span></span><span></span>
            </div>
            <p class="loading-status mt-3" id="loadingStatus">Initializing DNS resolver...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script>
    (function() {
        var statusMessages = [
            "Initializing DNS resolver...",
            "Querying authoritative nameservers...",
            "Pulling A/AAAA records via DNS over HTTPS...",
            "Fetching MX records for mail routing...",
            "Running RDAP lookup for registrar info...",
            "Parsing SPF record from TXT...",
            "Validating DMARC policy...",
            "Checking DKIM selectors...",
            "Querying DNSSEC chain of trust...",
            "Fetching CAA records...",
            "Checking MTA-STS policy...",
            "Validating BIMI configuration...",
            "Cross-referencing with Cloudflare DNS...",
            "Comparing against Google Public DNS...",
            "Aggregating results from multiple resolvers..."
        ];
        var currentIndex = 0;
        var intervalId = null;
        
        function cycleMessage() {
            var statusEl = document.getElementById('loadingStatus');
            if (!statusEl) return;
            currentIndex = (currentIndex + 1) % statusMessages.length;
            statusEl.textContent = statusMessages[currentIndex];
        }
        
        function startMessages() {
            currentIndex = 0;
            var statusEl = document.getElementById('loadingStatus');
            if (statusEl) statusEl.textContent = statusMessages[0];
            intervalId = setInterval(cycleMessage, 500);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(el) {
                return new bootstrap.Tooltip(el);
            });
            
            // Re-analyze button handler
            var reanalyzeBtn = document.getElementById('reanalyzeBtn');
            if (reanalyzeBtn) {
                reanalyzeBtn.addEventListener('click', function() {
                    var domain = this.getAttribute('data-domain');
                    var overlay = document.getElementById('loadingOverlay');
                    
                    // Show loading overlay
                    if (overlay) {
                        overlay.style.display = 'flex';
                        startMessages();
                    }
                    
                    // Update button state
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
                    this.disabled = true;
                    
                    // Fetch fresh results
                    var formData = new FormData();
                    formData.append('domain', domain);
                    
                    fetch('/analyze', {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow'
                    })
                    .then(function(response) {
                        return response.text().then(function(html) {
                            document.open();
                            document.write(html);
                            document.close();
                            if (response.url && response.url !== window.location.href) {
                                window.history.pushState({}, '', response.url);
                            }
                        });
                    })
                    .catch(function() {
                        window.location.href = '/analyze?domain=' + encodeURIComponent(domain);
                    });
                });
            }
        });
    })();
    </script>
</body>
</html>
