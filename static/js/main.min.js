function showOverlay(e){e&&(e.classList.add("is-active"),requestAnimationFrame(function(){requestAnimationFrame(function(){e.querySelectorAll(".loading-spinner, .loading-spinner i, .loading-dots span").forEach(function(e){const t=getComputedStyle(e).animationName;t&&"none"!==t&&(e.style.animation="none",e.offsetWidth,e.style.animation="")})})}))}function startStatusCycle(e){const t=document.getElementById("loadingTimer")||e.querySelector(".loading-elapsed span"),n=document.getElementById("loadingNote"),a=Date.now();if(t){t.textContent="0s";const n=setInterval(function(){const e=Math.floor((Date.now()-a)/1e3);t.textContent=e+"s"},1e3);e.dataset.timerId=n}n&&setTimeout(function(){n.classList.add("u-opacity-visible")},6e3);const s=e.querySelectorAll(".scan-phase");if(0===s.length)return;s.forEach(function(e,t){const n=Number.parseInt(e.dataset.delay,10)||0;setTimeout(function(){e.classList.add("visible","active-phase")},n);const a=n+1800+1200*Math.random();t!==s.length-1&&setTimeout(function(){e.classList.remove("active-phase"),e.classList.add("done");const t=e.querySelector(".scan-icon");t&&(t.classList.remove("fa-circle-notch","fa-spin","scan-pending"),t.offsetWidth,t.classList.add("fa-check-circle"))},a)})}function hideOverlayAndReset(e,t){e&&(e.classList.remove("is-active"),e.dataset.timerId&&(clearInterval(Number(e.dataset.timerId)),delete e.dataset.timerId)),document.body.classList.remove("loading"),t&&(t.innerHTML='<i class="fas fa-search me-1"></i> Analyze',t.disabled=!1)}function isValidDomain(e){if(!e)return!1;const t=e.replace(/^\.+/,"").replace(/\.+$/,"");if(t.length>253||0===t.length)return!1;const n=t.split(".");if(1===n.length)return/^[a-zA-Z]{2,}$/.test(n[0])||n[0].startsWith("xn--");for(const e of n){if(0===e.length||e.length>63)return!1;if(e.startsWith("-")||e.endsWith("-"))return!1}const a=n[n.length-1];if(/^\d+$/.test(a))return!1;if(!/[^\u0020-\u007F]/.test(t))for(const e of n)if(!/^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(e))return!1;return!0}function resetCopyBtn(e){e.innerHTML='<i class="fas fa-copy"></i>',e.classList.remove("copied")}function handleCopyResult(e,t){e.innerHTML=t?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>',t&&e.classList.add("copied"),setTimeout(function(){resetCopyBtn(e)},1500)}function createCopyHandler(e,t){return function(n){n.stopPropagation();let a="";e.childNodes.forEach(function(e){e===t||e.classList?.contains("copy-btn")||(a+=e.textContent)}),a=a.trim(),navigator.clipboard.writeText(a).then(function(){handleCopyResult(t,!0)}).catch(function(){handleCopyResult(t,!1)})}}"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").catch(function(){}),globalThis.addEventListener("pageshow",function(e){if(e.persisted){document.querySelectorAll(".loading-overlay").forEach(function(e){e.classList.remove("is-active"),e.dataset.timerId&&(clearInterval(Number(e.dataset.timerId)),delete e.dataset.timerId)}),document.body.classList.remove("loading");const e=document.getElementById("reanalyzeBtn");e&&!e.classList.contains("disabled")&&(e.innerHTML='<i class="fas fa-sync-alt me-2"></i>Re-analyze');const t=document.getElementById("analyzeBtn");t&&(t.innerHTML='<i class="fas fa-search me-1"></i> Analyze',t.disabled=!1),document.querySelectorAll(".history-view-btn,.history-reanalyze-btn").forEach(function(e){e.classList.remove("disabled"),e.removeAttribute("aria-disabled")})}}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("domainForm"),t=document.getElementById("domain"),n=document.getElementById("analyzeBtn");if(e&&t&&n){t.addEventListener("input",function(){const e=this.value.trim(),t=""===e||isValidDomain(e);e&&!t?(this.classList.add("is-invalid"),n.disabled=!0):(this.classList.remove("is-invalid"),n.disabled=!1)});let a=!1;e.addEventListener("submit",function(s){if(a)return;s.preventDefault();const o=t.value.trim().toLowerCase().replace(/^\./,"");if(t.value=o,!o)return void t.classList.add("is-invalid");if(!isValidDomain(o))return void t.classList.add("is-invalid");if(!e.checkValidity())return void e.reportValidity();const i=document.getElementById("loadingOverlay"),c=document.getElementById("loadingDomain");i&&(c&&(c.textContent=o),showOverlay(i),startStatusCycle(i)),n.textContent="";const l=document.createElement("i");l.className="fas fa-spinner fa-spin me-2",n.appendChild(l),n.appendChild(document.createTextNode("Analyzing...")),n.disabled=!0,document.body.classList.add("loading"),a=!0;const d=new FormData(e);fetch(e.action,{method:"POST",body:d,headers:{"X-Requested-With":"fetch"},redirect:"follow"}).then(function(e){if(!e.redirected)return e.text().then(function(t){document.open(),document.write(t),document.close(),e.url&&e.url!==globalThis.location.href&&globalThis.history.replaceState(null,"",e.url)});globalThis.location.href=e.url}).catch(function(){hideOverlayAndReset(i,n),a=!1;const t=document.createElement("div");t.className="alert alert-danger alert-dismissible fade show mt-3",t.setAttribute("role","alert"),t.textContent="Network error — please check your connection and try again.";const s=document.createElement("button");s.type="button",s.className="btn-close",s.setAttribute("data-bs-dismiss","alert"),t.appendChild(s),e.parentNode.insertBefore(t,e)})}),t.addEventListener("focus",function(){this.classList.remove("is-invalid")})}document.querySelectorAll('a[href^="/analyze?domain="]').forEach(function(e){"reanalyzeBtn"!==e.id&&(e.classList.contains("history-reanalyze-btn")||e.addEventListener("click",function(t){t.preventDefault();const n=document.getElementById("loadingOverlay"),a=document.getElementById("loadingDomain"),s=new URL(e.href,globalThis.location.origin).searchParams.get("domain")||"";n&&(a&&(a.textContent=s),showOverlay(n),startStatusCycle(n)),document.body.classList.add("loading"),setTimeout(function(){globalThis.location.href=e.href},80)}))}),document.querySelectorAll(".alert-dismissible:not(.alert-persistent)").forEach(function(e){setTimeout(function(){bootstrap.Alert.getOrCreateInstance(e).close()},5e3)}),document.querySelectorAll(".alert-dismissible .btn-close").forEach(function(e){e.addEventListener("click",function(){const t=e.closest(".alert");if(t)try{bootstrap.Alert.getOrCreateInstance(t).close()}catch(e){console.warn("Bootstrap alert fallback:",e.message),t.classList.remove("show"),t.addEventListener("transitionend",function(){t.remove()}),setTimeout(function(){t.remove()},300)}})}),document.querySelectorAll('a[href^="#"]').forEach(function(e){e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.href.substring(this.href.indexOf("#")));t&&t.scrollIntoView({behavior:"smooth",block:"start"})})}),document.querySelectorAll(".code-block").forEach(function(e){e.classList.add("u-pointer"),e.title="Click to copy";const t=document.createElement("button");t.type="button",t.className="copy-btn",t.setAttribute("aria-label","Copy to clipboard"),t.innerHTML='<i class="fas fa-copy"></i>',e.appendChild(t);const n=createCopyHandler(e,t);t.addEventListener("click",n),e.addEventListener("click",n)})});const allFixesCollapse=document.getElementById("allFixesCollapse");if(allFixesCollapse){const e=document.querySelector('[data-bs-target="#allFixesCollapse"]');if(e){const t=Array.from(e.childNodes).map(function(e){return e.cloneNode(!0)});allFixesCollapse.addEventListener("shown.bs.collapse",function(){e.textContent="";const t=document.createElement("i");t.className="fas fa-chevron-up me-1",e.appendChild(t),e.appendChild(document.createTextNode("Show fewer"))}),allFixesCollapse.addEventListener("hidden.bs.collapse",function(){e.textContent="",t.forEach(function(t){e.appendChild(t.cloneNode(!0))})})}}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function loadDNSHistory(e){const t=document.getElementById("dns-history-btn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin me-1"></i>Loading history…',fetch("/api/dns-history?domain="+encodeURIComponent(e)).then(function(e){return e.json()}).then(function(e){if(!e||"unavailable"===e.status||"error"===e.status||!e.available)return void t.closest(".dns-history-load-wrapper").classList.add("d-none");const n=document.getElementById("dns-history-section"),a=document.getElementById("dns-history-body"),s=document.getElementById("dns-history-source");if(!n||!a)return;s.textContent="Source: "+(e.source||"SecurityTrails");const o=e.changes||[];if(a.textContent="",0===o.length){const e=document.createElement("p");e.className="text-muted mb-0";const t=document.createElement("i");t.className="fas fa-check-circle text-success me-1",e.appendChild(t),e.appendChild(document.createTextNode("No DNS record changes detected in available history. A, AAAA, MX, and NS records for this domain have remained stable.")),a.appendChild(e)}else{const e=document.createElement("div");e.className="table-responsive";const t=document.createElement("table");t.className="table table-sm table-striped mb-0";const n=document.createElement("thead"),s=document.createElement("tr");[{text:"Date",cls:"u-w-80px"},{text:"Type",cls:"u-w-60px"},{text:"Action",cls:"u-w-70px"},{text:"Value"},{text:"Organization"},{text:"Timeline"}].forEach(function(e){const t=document.createElement("th");e.cls&&(t.className=e.cls),t.textContent=e.text,s.appendChild(t)}),n.appendChild(s),t.appendChild(n);const i=document.createElement("tbody");o.forEach(function(e){let t="secondary";"A"===e.record_type||"AAAA"===e.record_type?t="primary":"MX"===e.record_type?t="success":"NS"===e.record_type&&(t="info");const n=document.createElement("tr"),a=document.createElement("td"),s=document.createElement("code");s.className="text-muted u-fs-080em",s.textContent=e.date||"",a.appendChild(s);const o=document.createElement("td"),c=document.createElement("span");c.className="badge bg-"+t,c.textContent=e.record_type||"",o.appendChild(c);const l=document.createElement("td"),d=document.createElement("span"),r=document.createElement("i");"added"===e.action?(d.className="text-success",r.className="fas fa-plus-circle me-1",d.appendChild(r),d.appendChild(document.createTextNode("Added"))):(d.className="text-danger",r.className="fas fa-minus-circle me-1",d.appendChild(r),d.appendChild(document.createTextNode("Removed"))),l.appendChild(d);const m=document.createElement("td"),u=document.createElement("code");u.className="u-fs-085em",u.textContent=e.value||"",m.appendChild(u);const p=document.createElement("td"),f=document.createElement("span");f.className="text-muted",f.textContent=e.org||"—",p.appendChild(f);const h=document.createElement("td"),y=document.createElement("span");y.className="text-muted u-fs-085em",y.textContent=e.description||"",h.appendChild(y),n.appendChild(a),n.appendChild(o),n.appendChild(l),n.appendChild(m),n.appendChild(p),n.appendChild(h),i.appendChild(n)}),t.appendChild(i),e.appendChild(t),a.appendChild(e)}t.closest(".dns-history-load-wrapper").classList.add("d-none"),n.classList.remove("d-none")}).catch(function(){t.closest(".dns-history-load-wrapper").classList.add("d-none")}))}